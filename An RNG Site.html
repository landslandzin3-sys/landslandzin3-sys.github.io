<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="shortcut icon" href="ChatGPT Image 3 de fev. de 2026, 20_51_33.png" type="image/x-icon">
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>AN RNG SITE</title>

<style>
:root{
  --bg:#030303;
  --panel:#090909;
  --border:#1b1b1b;
  --white:#ffffff;

  --timeColor1:#00ffff;
  --timeColor2:#0077ff;
  --nightColor:#9b30ff;
  --blazeColor:#ff8c00;

  --hunterRed1:#ff2a2a;
  --hunterRed2:#b30000;

  --gold1:#ffd36a;
  --gold2:#ffb400;

  --cyan:#00ffff;
  --ciano:#00ffff;
  --levGreen:#19ff9a;
  --levCyan:#00e5ff;

  --sevBlue:#2aa7ff;
  --sevCyan:#00fff0;
  --sevDeep:#0b2bff;

  /* NEW */
  --sand1:#f2d27a;
  --sand2:#caa24a;
  --rain1:#bfe8ff;
  --rain2:#5dbbff;

  --blood1:#ff1a1a;
  --blood2:#7a0000;

  --angel1:#fff6c4;
  --angel2:#ffd36a;

  --overt1:#00a6ff;
  --overt2:#002dff;

  --ghost1:#caa8ff;
  --ghost2:#5a2cff;
}

/* GLOBAL */
*{box-sizing:border-box;font-family:Arial,Helvetica,sans-serif;}
body{
  margin:0;
  background:var(--bg);
  color:var(--white);
  display:flex;
  justify-content:center;
  align-items:flex-start;
  min-height:100svh;
}


#app{
  width:1100px;
  height:700px;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:18px;
  display:grid;
  grid-template-columns:260px 1fr 260px;
  position:relative;
  overflow:hidden;
}

@media (max-width: 900px){
  body{
    overflow:auto;              /* deixa rolar no celular */
    align-items:flex-start;
    padding:10px;
  }

  #app{
    width:100%;
    height:auto;                /* não força 100svh cortando conteúdo */
    min-height:100svh;
    grid-template-columns:1fr;  /* 1 coluna */
    grid-template-rows:auto auto auto;
    overflow:visible;           /* evita scroll “preso” dentro do app */
    border-radius:12px;
  }

  #left{ border-right:none; border-bottom:1px solid var(--border); }
  #right{ border-left:none; border-top:1px solid var(--border); }

  /* Lista de auras com scroll próprio (pra não ficar gigante) */
  #rollingAuras{
    height:auto;
    max-height:45svh;
    overflow-y:auto;
  }

  /* Effects list: não deixa “travar” */
  .effectBox{
    max-height:none;
    overflow:visible;
  }

  /* Overlays (Storage / Log / Potions) ficarem confortáveis no celular */
  .overlayPanel{
    width:92vw;
    max-height:82svh;
  }
}




#app.ready{ opacity:1; pointer-events:auto; }

#left,#right{padding:15px;}
#left{border-right:1px solid var(--border);}
#right{border-left:1px solid var(--border);}

/* ===== INTRO OVERLAY ===== */
#introOverlay{
  position:fixed; inset:0;
  background:#000;
  display:flex; align-items:center; justify-content:center;
  z-index:5000;
}
#introMessage{
  font-size:14px;
  letter-spacing:1px;
  opacity:0;
  transform:translateY(2px);
  transition:opacity 900ms ease, transform 900ms ease;
  text-align:center;
  padding:0 18px;
  color:#eaeaea;
}
#introOverlay.show #introMessage{
  opacity:0.95;
  transform:translateY(0px);
}
#introOverlay.fadeout{
  transition:opacity 900ms ease;
  opacity:0;
  pointer-events:none;
}

/* biome fx layer (behind UI) */
#biomeFX{
  position:absolute; inset:0;
  pointer-events:none;
  z-index:0;
  opacity:0;
  transition:opacity 380ms ease;
}
#app.biomeOn #biomeFX{ opacity:1; }

/* keep UI above biomeFX */
#left,#center,#right,
#whiteFlash,
.overlay, #panelAnim,
#layersSweep, #severanceFX{ position:relative; z-index:2; }

/* ===== BIOME VISUALS ===== */
#app.biomeInferno #biomeFX{
  background:
    radial-gradient(circle at 12% 25%, rgba(255,120,0,.05) 0 18px, rgba(0,0,0,0) 40px),
    radial-gradient(circle at 80% 40%, rgba(255,80,0,.04) 0 14px, rgba(0,0,0,0) 36px),
    radial-gradient(circle at 45% 78%, rgba(255,50,0,.035) 0 16px, rgba(0,0,0,0) 44px);
  animation:infernoPops 2.4s ease-in-out infinite;
}
@keyframes infernoPops{
  0%{filter:blur(0px); opacity:.0;}
  15%{opacity:.55;}
  50%{opacity:.25; filter:blur(1px);}
  85%{opacity:.55;}
  100%{opacity:0;}
}

/* Windstorm: wind streaks behind */
#app.biomeWindstorm #biomeFX{
  background:
    repeating-linear-gradient(
      110deg,
      rgba(255,255,255,0) 0px,
      rgba(255,255,255,0) 26px,
      rgba(255,255,255,.06) 26px,
      rgba(255,255,255,.06) 28px,
      rgba(255,255,255,0) 28px,
      rgba(255,255,255,0) 56px
    );
  opacity:.22;
  animation:windPass 1.6s linear infinite;
  mask-image: radial-gradient(circle at 50% 55%, rgba(0,0,0,1) 0 55%, rgba(0,0,0,.0) 90%);
}
@keyframes windPass{
  0%{transform:translate(-6%,-10%);}
  100%{transform:translate(6%,10%);}
}

/* Sky Realm: angelical almost invisible */
#app.biomeSky #biomeFX{
  background: radial-gradient(circle at 50% 35%, rgba(255,255,255,.06), rgba(0,0,0,0) 55%);
  opacity:.16;
  filter:blur(1px);
}

/* Aurora: faint colored */
#app.biomeAurora #biomeFX{
  background:
    radial-gradient(circle at 20% 35%, rgba(0,255,255,.05), rgba(0,0,0,0) 55%),
    radial-gradient(circle at 75% 55%, rgba(160,80,255,.04), rgba(0,0,0,0) 58%),
    radial-gradient(circle at 55% 15%, rgba(0,140,255,.03), rgba(0,0,0,0) 48%);
  opacity:.20;
  filter:blur(2px);
  animation:auroraDrift 5.5s ease-in-out infinite;
}
@keyframes auroraDrift{
  0%,100%{transform:translate(0,0);}
  50%{transform:translate(1.5%,-1%);}
}

/* NEW: Desert biome */
#app.biomeDesert #biomeFX{
  background:
    radial-gradient(circle at 20% 35%, rgba(242,210,122,.08), rgba(0,0,0,0) 55%),
    radial-gradient(circle at 75% 65%, rgba(202,162,74,.06), rgba(0,0,0,0) 58%),
    repeating-linear-gradient(
      120deg,
      rgba(0,0,0,0) 0px,
      rgba(0,0,0,0) 18px,
      rgba(242,210,122,.07) 18px,
      rgba(242,210,122,.07) 19px,
      rgba(0,0,0,0) 19px,
      rgba(0,0,0,0) 44px
    );
  opacity:.22;
  filter:blur(.3px);
  animation:desertDrift 1.5s linear infinite;
  mask-image: radial-gradient(circle at 50% 55%, rgba(0,0,0,1) 0 60%, rgba(0,0,0,.0) 92%);
}
@keyframes desertDrift{
  0%{transform:translate(-4%,-2%);}
  100%{transform:translate(4%,2%);}
}

/* NEW: Rain biome (hard to see droplets) */
#app.biomeRain #biomeFX{
  background:
    radial-gradient(circle at 50% 30%, rgba(191,232,255,.06), rgba(0,0,0,0) 55%),
    repeating-linear-gradient(
      100deg,
      rgba(255,255,255,0) 0px,
      rgba(255,255,255,0) 14px,
      rgba(191,232,255,.07) 14px,
      rgba(191,232,255,.07) 15px,
      rgba(255,255,255,0) 15px,
      rgba(255,255,255,0) 36px
    );
  opacity:.12;
  animation:rainFall 1.05s linear infinite;
  filter:blur(.25px);
  mask-image: radial-gradient(circle at 50% 55%, rgba(0,0,0,1) 0 62%, rgba(0,0,0,.0) 92%);
}
@keyframes rainFall{
  0%{transform:translate(-2%,-8%);}
  100%{transform:translate(2%,8%);}
}

/* Zero: invert everything */
#app.biomeZero{
  filter: invert(1) hue-rotate(180deg);
}

/* ===== LEFT LIST ===== */
#rollingAurasTitle{font-weight:bold;margin-bottom:8px;}
#rollingAuras{display:flex;flex-direction:column;gap:6px;height:100%;overflow-y:auto;}

.auraBox{
  border:1px solid var(--border);
  border-radius:12px;padding:6px;
  text-align:center;cursor:pointer;font-size:12px;
  position:relative;transition:transform 0.15s ease;
  overflow:hidden;
}
.auraBox:hover{transform:translateY(-1px);}

/* TIME */
.timeAuraBox{
  font-weight:bold;position:relative;display:inline-block;color:var(--timeColor1);
  text-shadow:0 0 6px var(--timeColor1),0 0 12px var(--timeColor2);
}
.timeAuraBox::before{
  content:'';position:absolute;top:50%;left:50%;
  width:80px;height:80px;margin:-40px 0 0 -40px;
  background:url('/mnt/data/e659b44d-a9d4-4b58-9b74-7fc7cfd0bede.png') no-repeat center/contain;
  z-index:-1;animation:spinClock 2s linear infinite;
}
@keyframes spinClock{
  0%{transform:translate(-50%,-50%) rotate(0deg);}
  100%{transform:translate(-50%,-50%) rotate(360deg);}
}

.nightAuraBox{color:white;text-shadow:0 0 6px var(--nightColor),0 0 12px var(--nightColor);}
.blazeAuraBox{color:white;text-shadow:0 0 6px var(--blazeColor),0 0 12px var(--blazeColor);}

/* NEW: Eclipse aura visual = metade Blaze + Night */
.eclipseAuraBox{
  color:#fff;
  text-shadow:
    0 0 7px var(--blazeColor),
    0 0 13px var(--blazeColor),
    0 0 7px var(--nightColor),
    0 0 13px var(--nightColor);
}
.eclipseAuraBox::before{
  content:"";
  position:absolute; inset:-30%;
  background:
    linear-gradient(90deg,
      rgba(255,140,0,.0),
      rgba(255,140,0,.18),
      rgba(155,48,255,.18),
      rgba(255,140,0,.0)
    );
  opacity:.35;
  animation:eclipseSweep 1.25s ease-in-out infinite;
  pointer-events:none;
  mix-blend-mode:screen;
}
@keyframes eclipseSweep{
  0%,100%{transform:translateX(-2%);}
  50%{transform:translateX(2%);}
}

/* Hunter style */
.hunterAuraBox{
  color:#fff;
  text-shadow:
    0 0 6px var(--hunterRed1),
    0 0 12px rgba(255,42,42,0.6),
    0 0 18px rgba(179,0,0,0.65);
  overflow:hidden;
}
.hunterAuraBox::after{
  content:"";
  position:absolute;inset:-40% -40%;
  background:
    repeating-linear-gradient(
      125deg,
      rgba(255,42,42,0.00) 0px,
      rgba(255,42,42,0.00) 10px,
      rgba(255,42,42,0.35) 10px,
      rgba(255,42,42,0.35) 12px,
      rgba(255,42,42,0.00) 12px,
      rgba(255,42,42,0.00) 22px
    );
  animation:hunterCuts 1.4s linear infinite;
  pointer-events:none;
  mix-blend-mode:screen;
}
@keyframes hunterCuts{
  0%{transform:translate(-10%,-10%);}
  100%{transform:translate(10%,10%);}
}

/* Galaxy / Comet styles */
.galaxyAuraBox{
  color:#fff;
  text-shadow:0 0 10px rgba(140,120,255,.9), 0 0 22px rgba(80,180,255,.45);
  overflow:hidden;
}
.galaxyAuraBox::before{
  content:"";
  position:absolute; inset:-30%;
  background:
    radial-gradient(circle, rgba(255,255,255,.85) 0 1px, transparent 2px) 0 0/22px 22px,
    radial-gradient(circle, rgba(255,255,255,.55) 0 1px, transparent 2px) 10px 12px/26px 26px,
    radial-gradient(circle, rgba(255,255,255,.35) 0 1px, transparent 2px) 16px 6px/30px 30px;
  opacity:.55;
  animation:starsDrift 3.5s linear infinite;
  pointer-events:none;
}
.galaxyAuraBox::after{
  content:"";
  position:absolute; inset:-60%;
  background:
    conic-gradient(from 90deg,
      rgba(170,80,255,.0),
      rgba(170,80,255,.35),
      rgba(60,200,255,.25),
      rgba(170,80,255,.0)
    );
  filter:blur(10px);
  opacity:.45;
  animation:galaxyArc 2.2s linear infinite;
  pointer-events:none;
  mix-blend-mode:screen;
}
@keyframes starsDrift{
  0%{transform:translate(-2%,-2%);}
  100%{transform:translate(2%,2%);}
}
@keyframes galaxyArc{
  0%{transform:rotate(0deg);}
  100%{transform:rotate(360deg);}
}

.cometAuraBox{
  color:#fff;
  text-shadow:0 0 10px rgba(140,255,255,.45), 0 0 18px rgba(120,140,255,.35);
  overflow:hidden;
}
.cometAuraBox::before{
  content:"";
  position:absolute; inset:-40%;
  background:
    repeating-linear-gradient(
      120deg,
      rgba(255,255,255,0) 0px,
      rgba(255,255,255,0) 18px,
      rgba(255,255,255,.35) 18px,
      rgba(255,255,255,.35) 20px,
      rgba(255,255,255,0) 20px,
      rgba(255,255,255,0) 42px
    );
  opacity:.25;
  animation:cometFall 1.1s linear infinite;
  pointer-events:none;
  mix-blend-mode:screen;
}
@keyframes cometFall{
  0%{transform:translate(-12%,-18%);}
  100%{transform:translate(12%,18%);}
}

/* Universe: like Galaxy but more intense */
.universeAuraBox{
  color:#fff;
  text-shadow:0 0 14px rgba(120,255,220,.55), 0 0 26px rgba(160,80,255,.55), 0 0 38px rgba(80,180,255,.35);
  overflow:hidden;
}
.universeAuraBox::before{
  content:"";
  position:absolute; inset:-40%;
  background:
    radial-gradient(circle, rgba(255,255,255,.95) 0 1px, transparent 2px) 0 0/18px 18px,
    radial-gradient(circle, rgba(255,255,255,.60) 0 1px, transparent 2px) 10px 12px/22px 22px,
    radial-gradient(circle, rgba(255,255,255,.40) 0 1px, transparent 2px) 16px 6px/26px 26px;
  opacity:.55;
  animation:starsDrift 1.6s linear infinite;
  pointer-events:none;
}
.universeAuraBox::after{
  content:"";
  position:absolute; inset:-70%;
  background:
    conic-gradient(from 130deg,
      rgba(0,255,255,.0),
      rgba(0,255,255,.22),
      rgba(170,80,255,.32),
      rgba(60,200,255,.22),
      rgba(0,255,255,.0)
    );
  filter:blur(10px);
  opacity:.55;
  animation:galaxyArc 1.2s linear infinite;
  pointer-events:none;
  mix-blend-mode:screen;
}

/* Layers aura */
.layersAuraBox{
  color:transparent;
  background: linear-gradient(90deg, #000 0%, #fff 50%, #000 100%);
  -webkit-background-clip:text;
  background-clip:text;
  text-shadow:0 0 10px rgba(255,255,255,.12);
  position:relative;
  animation:layersPulse 1.35s ease-in-out infinite;
}
.layersAuraBox::before{
  content:"";
  position:absolute; inset:-20%;
  background:
    radial-gradient(circle at 20% 35%, rgba(255,255,255,.30), rgba(0,0,0,0) 55%),
    radial-gradient(circle at 75% 65%, rgba(0,0,0,.28), rgba(0,0,0,0) 60%);
  filter:blur(8px);
  mix-blend-mode:screen;
  opacity:.55;
  animation:layersSwirl 1.9s linear infinite;
  pointer-events:none;
}
@keyframes layersPulse{
  0%,100%{transform:translate(-50%,-50%) scale(1);}
  50%{transform:translate(-50%,-50%) scale(0.94);}
}
@keyframes layersSwirl{
  0%{transform:rotate(0deg) translate(0,0);}
  100%{transform:rotate(360deg) translate(0,0);}
}
.layersSwapA{
  background:linear-gradient(90deg, #000 0%, #fff 55%, #000 100%);
  -webkit-background-clip:text;background-clip:text;color:transparent;
}
.layersSwapB{
  background:linear-gradient(90deg, #fff 0%, #000 55%, #fff 100%);
  -webkit-background-clip:text;background-clip:text;color:transparent;
}

/* Photon */
.photonAuraBox{
  color:#fff;
  text-shadow:0 0 10px rgba(255,255,255,.55), 0 0 20px rgba(255,255,255,.22);
}
.photonAuraBox::before{
  content:"";
  position:absolute; inset:-50%;
  background:
    repeating-linear-gradient(
      120deg,
      rgba(255,255,255,0) 0px,
      rgba(255,255,255,0) 18px,
      rgba(255,255,255,.55) 18px,
      rgba(255,255,255,.55) 19px,
      rgba(255,255,255,0) 19px,
      rgba(255,255,255,0) 38px
    );
  opacity:.38;
  animation:photonRush 420ms linear infinite;
  pointer-events:none;
  mix-blend-mode:screen;
}
@keyframes photonRush{
  0%{transform:translate(-16%,-16%);}
  100%{transform:translate(16%,16%);}
}

/* Money */
.moneyAuraBox{
  color:#fff;
  text-shadow:0 0 8px rgba(255,210,80,.55), 0 0 16px rgba(255,180,0,.35);
}
.moneyAuraBox::before{
  content:"$";
  position:absolute;left:10px;top:8px;
  font-weight:bold;
  color:rgba(255,210,80,.8);
  text-shadow:0 0 12px rgba(255,190,0,.35);
  transform:rotate(-14deg);
}
.moneyAuraBox::after{
  content:"";
  position:absolute; inset:-40%;
  background:
    radial-gradient(circle, rgba(255,210,80,.85) 0 1px, transparent 2px) 0 0/18px 18px,
    radial-gradient(circle, rgba(255,210,80,.55) 0 1px, transparent 2px) 10px 12px/24px 24px;
  opacity:.35;
  animation:moneyDrift 1.4s linear infinite;
  pointer-events:none;
  mix-blend-mode:screen;
}
@keyframes moneyDrift{
  0%{transform:translate(-2%,-10%);}
  100%{transform:translate(2%,10%);}
}

/* Web */
.webAuraBox{
  color:#e8f7ff;
  text-shadow:0 0 10px rgba(0,170,255,.55), 0 0 18px rgba(0,110,255,.25);
}
.webAuraBox::before{
  content:"";
  position:absolute; inset:-20%;
  background:
    linear-gradient(90deg, rgba(0,200,255,.00), rgba(0,200,255,.14), rgba(0,200,255,.00)),
    repeating-linear-gradient(0deg, rgba(0,170,255,.00) 0px, rgba(0,170,255,.00) 18px, rgba(0,170,255,.16) 18px, rgba(0,170,255,.16) 19px),
    repeating-linear-gradient(90deg, rgba(0,170,255,.00) 0px, rgba(0,170,255,.00) 28px, rgba(0,170,255,.12) 28px, rgba(0,170,255,.12) 29px);
  opacity:.45;
  animation:webPanels 1.25s ease-in-out infinite;
  pointer-events:none;
  mix-blend-mode:screen;
}
@keyframes webPanels{
  0%,100%{transform:translate(-1.5%,0); filter:blur(.3px);}
  50%{transform:translate(1.5%,0); filter:blur(0px);}
}

/* Balance */
.balanceAuraBox{
  color:#fff;
  text-shadow:0 0 10px rgba(255,255,255,.35), 0 0 18px rgba(255,255,255,.18);
}
.balanceAuraBox::before{
  content:"+  -  +  -";
  position:absolute;left:50%;top:50%;
  transform:translate(-50%,-50%);
  font-weight:bold;
  letter-spacing:6px;
  opacity:.18;
  animation:balanceSlide 900ms linear infinite;
  pointer-events:none;
}
@keyframes balanceSlide{
  0%{transform:translate(-60%,-50%);}
  100%{transform:translate(-40%,-50%);}
}

/* Legendary (WITH halo) - keep for Rolling/Storage */
.legendaryAuraBox{
  color:#fff;
  text-shadow:0 0 10px rgba(255,210,80,.7), 0 0 22px rgba(255,180,0,.35);
}
.legendaryAuraBox::before{
  content:"";
  position:absolute; inset:-35%;
  background:
    conic-gradient(from 90deg,
      rgba(255,210,80,.0),
      rgba(255,210,80,.22),
      rgba(255,180,0,.18),
      rgba(255,210,80,.0)
    );
  opacity:.45;
  filter:blur(10px);
  animation:legendArc 1.4s linear infinite;
  pointer-events:none;
  mix-blend-mode:screen;
}
@keyframes legendArc{
  0%{transform:rotate(0deg);}
  100%{transform:rotate(360deg);}
}

/* Legendary (NO halo) - use ONLY in rollBox */
.legendaryNoHalo{
  color:#fff;
  text-shadow:0 0 10px rgba(255,210,80,.7), 0 0 22px rgba(255,180,0,.35);
}

/* Chromatic */
.chromaticAuraBox{
  font-weight:bold;
  text-shadow:0 0 14px rgba(255,140,0,.35), 0 0 26px rgba(255,60,0,.22);
}

/* Leviathan */
.leviathanAuraBox{
  font-family: "Impact", "Haettenschweiler", "Franklin Gothic Heavy", "Arial Black", sans-serif;
  letter-spacing:1px;
  color:#eafff8;
  text-shadow:0 0 12px rgba(0,255,180,.35), 0 0 22px rgba(0,220,255,.25);
}
.leviathanAuraBox::before{
  content:"";
  position:absolute; inset:-30%;
  background:
    radial-gradient(circle at 10% 20%, rgba(25,255,154,.18), rgba(0,0,0,0) 50%),
    radial-gradient(circle at 80% 70%, rgba(0,229,255,.14), rgba(0,0,0,0) 55%),
    repeating-radial-gradient(circle at 40% 40%,
      rgba(0,255,180,.12) 0px,
      rgba(0,255,180,.12) 2px,
      rgba(0,0,0,0) 4px,
      rgba(0,0,0,0) 10px
    );
  opacity:.55;
  filter:blur(.2px);
  animation:levScales 1.6s ease-in-out infinite;
  pointer-events:none;
}
@keyframes levScales{
  0%,100%{transform:translate(0,0) rotate(0deg);}
  50%{transform:translate(1.2%,-0.8%) rotate(1deg);}
}
.leviathanAuraBox::after{ content:none !important; }

/* Severance */
.severanceAuraBox{
  color:#e9fbff;
  text-shadow:
    0 0 10px rgba(0,255,240,.35),
    0 0 22px rgba(42,167,255,.35),
    0 0 32px rgba(11,43,255,.18);
}
.severanceAuraBox::before{
  content:"";
  position:absolute; inset:-40%;
  background:
    radial-gradient(circle, rgba(255,255,255,.85) 0 1px, transparent 2px) 0 0/14px 14px,
    radial-gradient(circle, rgba(0,255,240,.55) 0 1px, transparent 2px) 9px 12px/18px 18px,
    radial-gradient(circle, rgba(42,167,255,.45) 0 1px, transparent 2px) 16px 6px/22px 22px;
  opacity:.45;
  animation:sevBugs 520ms linear infinite;
  pointer-events:none;
  mix-blend-mode:screen;
}
@keyframes sevBugs{
  0%{transform:translate(-2%,-2%);}
  100%{transform:translate(2%,2%);}
}

/* ===== NEW AURAS FX ===== */

/* Phantom (unknown effects) -> ghosty purple shimmer */
.phantomAuraBox{
  color:#f3eaff;
  text-shadow:0 0 10px rgba(202,168,255,.45), 0 0 18px rgba(90,44,255,.25);
  overflow:hidden;
}
.phantomAuraBox::before{
  content:"";
  position:absolute; inset:-35%;
  background:
    radial-gradient(circle at 30% 40%, rgba(202,168,255,.14), rgba(0,0,0,0) 55%),
    radial-gradient(circle at 75% 60%, rgba(90,44,255,.10), rgba(0,0,0,0) 60%),
    linear-gradient(90deg, rgba(255,255,255,0), rgba(202,168,255,.14), rgba(255,255,255,0));
  opacity:.55;
  animation:phantomWisp 1.4s ease-in-out infinite;
  pointer-events:none;
  mix-blend-mode:screen;
}
@keyframes phantomWisp{
  0%,100%{transform:translate(-1.5%,0); filter:blur(.6px);}
  50%{transform:translate(1.5%,0); filter:blur(.2px);}
}

/* Overture (Time mutation) -> super clock + stars, blue/dark blue */
.overtureAuraBox{
  color:#e8f7ff;
  text-shadow:0 0 10px rgba(0,166,255,.55), 0 0 22px rgba(0,45,255,.35);
  font-weight:bold;
  overflow:hidden;
}
.overtureAuraBox::before{
  content:"";
  position:absolute; left:50%; top:50%;
  width:120px; height:120px;
  margin-left:-60px; margin-top:-60px;
  background:url('/mnt/data/e659b44d-a9d4-4b58-9b74-7fc7cfd0bede.png') no-repeat center/contain;
  opacity:.65;
  filter:drop-shadow(0 0 14px rgba(0,166,255,.25));
  animation:overtureClock 1.35s linear infinite;
  pointer-events:none;
  z-index:-1;
}
@keyframes overtureClock{
  0%{transform:rotate(0deg);}
  100%{transform:rotate(360deg);}
}
.overtureAuraBox::after{
  content:"";
  position:absolute; inset:-40%;
  background:
    radial-gradient(circle, rgba(255,255,255,.95) 0 1px, transparent 2px) 0 0/16px 16px,
    radial-gradient(circle, rgba(0,166,255,.75) 0 1px, transparent 2px) 9px 12px/22px 22px,
    radial-gradient(circle, rgba(0,45,255,.55) 0 1px, transparent 2px) 16px 6px/28px 28px;
  opacity:.45;
  animation:overtureStars 520ms linear infinite;
  pointer-events:none;
  mix-blend-mode:screen;
}
@keyframes overtureStars{
  0%{transform:translate(-2%,-2%);}
  100%{transform:translate(2%,2%);}
}

/* Archangel -> golden/white angelic glow, petals + wings illusion */
.archangelAuraBox{
  color:#fffdf0;
  text-shadow:0 0 12px rgba(255,214,106,.55), 0 0 22px rgba(255,255,255,.25);
  font-weight:bold;
  overflow:hidden;
}
.archangelAuraBox::before{
  content:"";
  position:absolute; inset:-35%;
  background:
    radial-gradient(circle at 50% 40%, rgba(255,246,196,.18), rgba(0,0,0,0) 55%),
    linear-gradient(90deg, rgba(255,255,255,0), rgba(255,214,106,.16), rgba(255,255,255,0)),
    radial-gradient(ellipse at 25% 52%, rgba(255,255,255,.14), rgba(0,0,0,0) 60%),
    radial-gradient(ellipse at 75% 52%, rgba(255,255,255,.14), rgba(0,0,0,0) 60%);
  opacity:.55;
  animation:archangelGlow 1.25s ease-in-out infinite;
  pointer-events:none;
  mix-blend-mode:screen;
}
@keyframes archangelGlow{
  0%,100%{transform:translateY(0px); filter:blur(.5px);}
  50%{transform:translateY(-1px); filter:blur(.2px);}
}
.archangelAuraBox::after{
  content:"";
  position:absolute; inset:-50%;
  background:
    radial-gradient(circle, rgba(255,214,106,.95) 0 1px, transparent 2px) 0 0/24px 24px,
    radial-gradient(circle, rgba(255,255,255,.75) 0 1px, transparent 2px) 10px 14px/28px 28px;
  opacity:.18;
  animation:petalsFall 1.3s linear infinite;
  pointer-events:none;
}
@keyframes petalsFall{
  0%{transform:translate(-3%,-12%);}
  100%{transform:translate(3%,12%);}
}

/* Bloodmoon -> red moon + blood rain */
.bloodmoonAuraBox{
  color:#fff;
  text-shadow:0 0 10px rgba(255,26,26,.55), 0 0 22px rgba(122,0,0,.45);
  font-weight:bold;
  overflow:hidden;
}
.bloodmoonAuraBox::before{
  content:"";
  position:absolute; left:50%; top:52%;
  width:88px;height:88px;
  margin-left:-44px;margin-top:-44px;
  border-radius:999px;
  background:
    radial-gradient(circle at 40% 35%, rgba(255,100,100,.45), rgba(255,26,26,.35) 35%, rgba(122,0,0,.25) 70%, rgba(0,0,0,0) 72%);
  filter:blur(.2px);
  opacity:.95;
  pointer-events:none;
  z-index:-1;
}
.bloodmoonAuraBox::after{
  content:"";
  position:absolute; inset:-40%;
  background:
    repeating-linear-gradient(
      90deg,
      rgba(255,26,26,0) 0px,
      rgba(255,26,26,0) 18px,
      rgba(255,26,26,.16) 18px,
      rgba(255,26,26,.16) 19px,
      rgba(255,26,26,0) 19px,
      rgba(255,26,26,0) 46px
    );
  opacity:.32;
  animation:bloodRain 820ms linear infinite;
  pointer-events:none;
  mix-blend-mode:screen;
}
@keyframes bloodRain{
  0%{transform:translateY(-10%);}
  100%{transform:translateY(10%);}
}

/* ===== DESERT AURAS FX ===== */
.sandAuraBox{
  color:#fff7d6;
  text-shadow:0 0 10px rgba(242,210,122,.45), 0 0 18px rgba(202,162,74,.25);
  overflow:hidden;
}
.sandAuraBox::before{
  content:"";
  position:absolute; inset:-35%;
  background:
    repeating-linear-gradient(
      120deg,
      rgba(0,0,0,0) 0px,
      rgba(0,0,0,0) 16px,
      rgba(242,210,122,.16) 16px,
      rgba(242,210,122,.16) 18px,
      rgba(0,0,0,0) 18px,
      rgba(0,0,0,0) 40px
    );
  opacity:.35;
  animation:desertDrift 1.25s linear infinite;
  pointer-events:none;
  mix-blend-mode:screen;
}

.tempestAuraBox{
  color:#fff;
  text-shadow:0 0 10px rgba(242,210,122,.40), 0 0 20px rgba(255,255,255,.18);
  overflow:hidden;
}
.tempestAuraBox::before{
  content:"";
  position:absolute; inset:-45%;
  background:
    repeating-linear-gradient(
      115deg,
      rgba(255,255,255,0) 0px,
      rgba(255,255,255,0) 18px,
      rgba(242,210,122,.20) 18px,
      rgba(242,210,122,.20) 20px,
      rgba(255,255,255,0) 20px,
      rgba(255,255,255,0) 44px
    );
  opacity:.40;
  animation:cometFall 0.9s linear infinite;
  pointer-events:none;
  mix-blend-mode:screen;
}

.pragueAuraBox{
  color:#eaffcf;
  text-shadow:0 0 10px rgba(120,255,120,.28), 0 0 18px rgba(0,150,80,.20);
  overflow:hidden;
}
.pragueAuraBox::before{
  content:"";
  position:absolute; inset:-35%;
  background:
    radial-gradient(circle, rgba(120,255,120,.55) 0 1px, transparent 2px) 0 0/18px 18px,
    radial-gradient(circle, rgba(0,150,80,.45) 0 1px, transparent 2px) 10px 12px/24px 24px;
  opacity:.28;
  animation:moneyDrift 1.2s linear infinite;
  pointer-events:none;
  mix-blend-mode:screen;
}

/* CENTER */
#center{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;}
#titleWrap{display:flex;flex-direction:column;align-items:center;gap:2px;margin-bottom:2px;}
#title{
  font-size:34px;letter-spacing:4px;
  animation:floatSoft 7s ease-in-out infinite;
}
#subtitle{
  font-size:12px;opacity:0.78;letter-spacing:1.6px;
}
@keyframes floatSoft{50%{transform:translateY(-2px);} }

#effectEquippedLabel{font-size:14px;margin-bottom:2px;}
#biomeLabel{font-size:16px;transition:transform 0.12s ease;}
#rollsLabel{font-size:12px;}

#rollBox{
  width:220px;
  height:150px;
  border:1px solid var(--border);
  border-radius:14px;
  position:relative;
  overflow:hidden;
}

/* FIX: Aura dead-center, rarity below */
#rolledAura{
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  text-align:center;
  z-index:2;
  font-size:18px;
  pointer-events:none;
}
#rolledRarity{
  position:absolute;
  left:50%;
  bottom:28px;
  transform:translateX(-50%);
  text-align:center;
  font-size:12px;
  color:#ccc;
  z-index:2;
  pointer-events:none;
}
#rolledMulti{
  position:absolute;
  left:50%;
  bottom:6px;
  transform:translateX(-50%);
  font-size:11px;
  color:#dcdcdc;
  opacity:0.95;
  text-align:center;
  line-height:1.25;
  white-space:pre-line;
  z-index:2;
  pointer-events:none;
}

/* roll button */
#rollBtn{padding:7px 18px;border-radius:18px;background:none;border:1px solid var(--white);color:var(--white);cursor:pointer;}
#rollBtn.disabled{opacity:0.5;pointer-events:none;}

#bonusLabel{
  font-size:14px;
  opacity:0.92;
  letter-spacing:0.6px;
  margin-top:2px;
}
#coinsWrap{font-size:12px;margin-top:2px;position:relative; text-align:center;}
#coinsWrap .coinFloat{
  position:absolute;right:-6px;top:-14px;
  font-size:12px;color:#fff;opacity:0;
  transform:translateY(0);
  pointer-events:none;
}
#currentLuck{
  font-size:12px;
  opacity:0.88;
  margin-top:4px;
  letter-spacing:0.4px;
}

/* Effects panel */
.effectBox{border:1px solid var(--border);border-radius:14px;padding:10px;margin-bottom:12px;overflow-y:auto;max-height:580px;}
.effectBox button{width:100%;margin-top:6px;border-radius:14px;border:1px solid white;background:none;color:white;cursor:pointer;}
.buyStorageBtn{width:100%;margin-bottom:6px;border:1px solid var(--white);background:none;color:white;border-radius:12px;cursor:pointer;}

/* button bounce */
.btnBounce{animation:btnBounce 260ms cubic-bezier(.2,1.4,.35,1) both;}
@keyframes btnBounce{
  0%{transform:scale(1);}
  40%{transform:scale(0.92);}
  100%{transform:scale(1);}
}

/* roll anim on aura text only */
@keyframes rollAnim{
  0%   { transform: translate(-50%,-50%) scale(0.2); }
  70%  { transform: translate(-50%,-50%) scale(1.08); }
  100% { transform: translate(-50%,-50%) scale(1); }
}
.rollAnim{ animation: rollAnim 0.5s cubic-bezier(.2,1.4,.4,1) forwards; }

/* click spark */
.spark{
  position:absolute;left:50%;top:50%;
  transform:translate(-50%,-50%);
  width:0;height:0;border-radius:50%;
  pointer-events:none;z-index:6;
  background:radial-gradient(circle, rgba(255,255,255,0.55) 0%, rgba(255,255,255,0.18) 40%, rgba(255,255,255,0) 70%);
}

/* explosions */
.explosion{
  position:absolute;left:50%;top:50%;
  transform:translate(-50%,-50%);
  width:0;height:0;border-radius:50%;
  pointer-events:none;z-index:5;
  background:radial-gradient(circle, rgba(255,255,255,0.90) 0%, rgba(255,255,255,0.35) 35%, rgba(255,255,255,0.00) 70%);
}
.explosion.super{
  background:radial-gradient(circle, rgba(255,255,255,1.0) 0%, rgba(255,255,255,0.75) 28%, rgba(255,255,255,0.00) 72%);
  box-shadow:0 0 28px rgba(255,255,255,0.55);
}

/* galaxy explosion */
.explosion.galaxy{
  background:radial-gradient(circle,
    rgba(255,255,255,1) 0%,
    rgba(150,80,255,.85) 18%,
    rgba(60,210,255,.55) 34%,
    rgba(0,0,0,0) 72%
  );
  box-shadow:0 0 45px rgba(170,80,255,.45), 0 0 65px rgba(60,210,255,.35);
}
.explosion.universe{
  background:radial-gradient(circle,
    rgba(255,255,255,1) 0%,
    rgba(0,255,255,.55) 16%,
    rgba(170,80,255,.70) 32%,
    rgba(60,210,255,.40) 46%,
    rgba(0,0,0,0) 74%
  );
  box-shadow:0 0 55px rgba(0,255,255,.25), 0 0 85px rgba(170,80,255,.22);
}

/* white flash */
#whiteFlash{
  position:absolute;inset:0;
  background:#fff;
  opacity:0;
  pointer-events:none;
  z-index:2000;
  transition:opacity 120ms ease;
}

/* layers cutscene overlay */
#layersSweep{
  position:absolute; inset:0;
  pointer-events:none;
  z-index:1500;
  opacity:0;
}
#layersSweep.show{opacity:1;}
#layersSweep .circle{
  position:absolute;
  left:50%; top:50%;
  width:1400px; height:1400px;
  margin-left:-700px; margin-top:-700px;
  border-radius:999px;
  border:2px solid rgba(255,255,255,.18);
  box-shadow:0 0 40px rgba(255,255,255,.08);
  transform:scale(1.55);
  opacity:0.85;
}
#layersSweep .shade{
  position:absolute; inset:0;
  background:rgba(0,0,0,0);
  opacity:0;
}
#layersSweep .whiteBurst{
  position:absolute; inset:0;
  background:#fff;
  opacity:0;
}
#layersSweep.sweep .circle{
  animation:layersCircleIn 620ms cubic-bezier(.2,1.15,.25,1) both;
}
@keyframes layersCircleIn{
  0%{transform:scale(1.55); opacity:.85;}
  100%{transform:scale(0.22); opacity:0.05;}
}
#layersSweep.sweep .shade{
  animation:layersShade 620ms cubic-bezier(.2,1.1,.25,1) both;
}
@keyframes layersShade{
  0%{opacity:0; background:rgba(0,0,0,0);}
  100%{opacity:1; background:rgba(0,0,0,.55);}
}
#layersSweep.burst .whiteBurst{
  animation:layersWhiteCover 1400ms ease-out both;
}
@keyframes layersWhiteCover{
  0%{opacity:0;}
  15%{opacity:1;}
  70%{opacity:1;}
  100%{opacity:0;}
}

/* Severance cutscene overlay */
#severanceFX{
  position:absolute; inset:0;
  pointer-events:none;
  z-index:1600;
  opacity:0;
}
#severanceFX.show{opacity:1;}
#severanceFX .scan{
  position:absolute; inset:0;
  background:
    repeating-linear-gradient(
      0deg,
      rgba(255,255,255,0) 0px,
      rgba(255,255,255,0) 7px,
      rgba(255,255,255,.05) 7px,
      rgba(255,255,255,.05) 8px
    );
  opacity:.55;
  mix-blend-mode:screen;
  animation:sevScan 240ms linear infinite;
}
@keyframes sevScan{
  0%{transform:translateY(-2%);}
  100%{transform:translateY(2%);}
}
#severanceFX .flash{
  position:absolute; inset:0;
  background:radial-gradient(circle at 50% 50%, rgba(0,255,240,.35), rgba(0,0,0,0) 58%);
  opacity:0.0;
  animation:sevFlash 220ms linear infinite;
}
@keyframes sevFlash{
  0%{opacity:0;}
  40%{opacity:.85;}
  100%{opacity:0;}
}
#severanceFX .popLayer{ position:absolute; inset:0; }
.sevPop{
  position:absolute;
  width:180px;height:90px;
  border:1px solid rgba(255,255,255,.55);
  border-radius:12px;
  background:rgba(0,0,0,0.65);
  box-shadow:0 0 18px rgba(42,167,255,.25);
  overflow:hidden;
}
.sevPop::before{
  content:"SYSTEM";
  position:absolute;left:10px;top:8px;
  font-size:11px;
  letter-spacing:1px;
  opacity:.85;
  color:rgba(255,255,255,.85);
}
.sevPop::after{
  content:"";
  position:absolute; inset:-30%;
  background:
    linear-gradient(90deg, rgba(0,255,240,0), rgba(0,255,240,.25), rgba(0,255,240,0));
  opacity:.55;
  animation:sevPopSweep 480ms linear infinite;
  mix-blend-mode:screen;
}
@keyframes sevPopSweep{
  0%{transform:translateX(-20%);}
  100%{transform:translateX(20%);}
}

/* Leviathan "borders on fire" for 0.5s */
#app.leviathanBurn{ animation:levFirePulse 500ms linear both; }
@keyframes levFirePulse{
  0%{ box-shadow:0 0 0 rgba(0,0,0,0), 0 0 0 rgba(0,0,0,0); }
  12%{ box-shadow:0 0 22px rgba(255,120,0,.35), 0 0 45px rgba(255,40,0,.18); }
  50%{ box-shadow:0 0 30px rgba(255,120,0,.45), 0 0 65px rgba(255,40,0,.22); }
  100%{ box-shadow:0 0 0 rgba(0,0,0,0), 0 0 0 rgba(0,0,0,0); }
}

/* app shakes */
.shakeLight{animation:shakeLight 520ms linear both;}
@keyframes shakeLight{
  0%{transform:translate(0,0);}
  15%{transform:translate(-1px,1px);}
  30%{transform:translate(1px,-1px);}
  45%{transform:translate(-1px,0px);}
  60%{transform:translate(1px,1px);}
  75%{transform:translate(0px,-1px);}
  100%{transform:translate(0,0);}
}
.shakeHard{animation:shakeHard 520ms linear both;}
@keyframes shakeHard{
  0%{transform:translate(0,0);}
  10%{transform:translate(-7px, 4px);}
  20%{transform:translate(7px,-4px);}
  30%{transform:translate(-6px,-5px);}
  40%{transform:translate(6px, 5px);}
  50%{transform:translate(-5px, 3px);}
  60%{transform:translate(5px,-3px);}
  70%{transform:translate(-4px,-2px);}
  80%{transform:translate(4px, 2px);}
  90%{transform:translate(-3px, 1px);}
  100%{transform:translate(0,0);}
}

/* severance zoom */
#app.sevZoom{ animation:sevZoom 800ms cubic-bezier(.18,1.05,.2,1) both; }
@keyframes sevZoom{
  0%{transform:scale(1);}
  12%{transform:scale(1.15);}
  100%{transform:scale(1);}
}

/* overlays base */
.overlay{
  position:absolute;inset:0;
  background:rgba(0,0,0,0.0);
  opacity:0;pointer-events:none;
  transition:opacity 450ms ease, background 450ms ease;
  z-index:999;
}
.overlay.show{opacity:1;background:rgba(0,0,0,0.80);pointer-events:auto;}
.overlayClose{
  position:absolute;top:14px;right:18px;
  width:38px;height:38px;border-radius:12px;
  border:1px solid var(--white);background:none;color:var(--white);
  font-size:18px;cursor:pointer;
}
.overlayPanel{
  position:absolute;top:50%;left:50%;
  transform:translate(-50%,-50%) scale(0.92);
  width:760px;max-width:92%;
  border:1px solid var(--border);border-radius:18px;
  background:rgba(9,9,9,0.95);
  padding:16px;
  box-shadow:0 0 40px rgba(0,0,0,0.7);
  max-height:600px;
  overflow:auto;
  opacity:0;
}
.overlay.show .overlayPanel{
  opacity:1;
  transform:translate(-50%,-50%) scale(1);
  transition:opacity 240ms ease 220ms, transform 420ms cubic-bezier(.2,1.2,.25,1) 220ms;
}

/* shared open/close anim */
#panelAnim{
  position:absolute;left:50%;top:50%;
  transform:translate(-50%,-50%);
  width:14px;height:14px;border-radius:999px;
  background:#fff;
  opacity:0;
  pointer-events:none;
  z-index:1200;
  filter:drop-shadow(0 0 10px rgba(255,255,255,.25));
}
#panelAnim.opening{animation:animOpen 520ms cubic-bezier(.2,1.2,.25,1) both;}
#panelAnim.closing{animation:animClose 520ms cubic-bezier(.2,1.2,.25,1) both;}
@keyframes animOpen{
  0%{opacity:0; width:14px; height:14px; border-radius:999px;}
  10%{opacity:1;}
  35%{opacity:1; width:360px; height:6px; border-radius:999px;}
  100%{opacity:0; width:360px; height:6px; border-radius:999px;}
}
@keyframes animClose{
  0%{opacity:0; width:360px; height:6px; border-radius:999px;}
  20%{opacity:1;}
  65%{opacity:1; width:14px; height:14px; border-radius:999px;}
  100%{opacity:0; width:14px; height:14px; border-radius:999px;}
}

/* potions UI */
#potionsPanel h2, #logPanel h2, #storagePanel h2{margin:0 0 10px 0;font-size:18px;letter-spacing:1px;}
.potionCard{border:1px solid var(--border);border-radius:14px;padding:10px;margin-bottom:10px;}
.potionRow{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;}
.potionName{font-weight:bold;}
.potionDesc{font-size:12px;color:#cfcfcf;margin-top:4px;line-height:1.35;}
.potionNeeds{font-size:12px;color:#cfcfcf;margin-top:8px;}
.potionActions{min-width:190px;display:flex;flex-direction:column;gap:8px;}
.potionActions button{
  width:100%;
  border-radius:12px;
  border:1px solid white;
  background:none;
  color:white;
  cursor:pointer;
  padding:7px 10px;
}
.potionActions button.secondary{border-color:rgba(255,255,255,0.9);}

/* active potion minis */
#activePotions{
  position:absolute;right:8px;bottom:8px;
  display:flex;flex-direction:column;gap:6px;z-index:6;
}
.potionMini{
  border:1px solid var(--border);
  background:rgba(0,0,0,0.6);
  border-radius:10px;
  padding:4px 8px;
  font-size:12px;
  display:flex;gap:8px;align-items:center;
}
.potionMini .sym{font-size:14px;line-height:1;}
.potionMini.glow{border-color:#fff;box-shadow:0 0 14px rgba(255,255,255,0.25);}

/* biome shake label */
.shake{animation:shake 350ms linear both;}
@keyframes shake{
  0%{transform:translateX(0);}
  20%{transform:translateX(-2px);}
  40%{transform:translateX(2px);}
  60%{transform:translateX(-2px);}
  80%{transform:translateX(2px);}
  100%{transform:translateX(0);}
}

/* log formatting */
.logSection{border:1px solid var(--border);border-radius:14px;padding:10px;margin-bottom:10px;}
.logSection h3{margin:0 0 6px 0;font-size:14px;letter-spacing:0.5px;}
.logSection ul{margin:0;padding-left:18px;color:#d7d7d7;font-size:12px;line-height:1.5;}

/* ui pulse */
.pulseUI{animation:pulseUI 520ms ease both;}
@keyframes pulseUI{
  0%{filter:drop-shadow(0 0 0 rgba(255,255,255,0));}
  40%{filter:drop-shadow(0 0 12px rgba(255,255,255,0.18));}
  100%{filter:drop-shadow(0 0 0 rgba(255,255,255,0));}
}

/* rollBox bg fx */
#rollBox.galaxyActive::before,
#rollBox.universeActive::before{
  content:"";
  position:absolute; inset:-30%;
  background:
    radial-gradient(circle, rgba(255,255,255,.9) 0 1px, transparent 2px) 0 0/20px 20px,
    radial-gradient(circle, rgba(255,255,255,.45) 0 1px, transparent 2px) 9px 12px/28px 28px;
  opacity:.55;
  animation:starsDrift 2.5s linear infinite;
  pointer-events:none;
  z-index:1;
}
#rollBox.universeActive::before{
  opacity:.7;
  filter:blur(.6px);
  animation:starsDrift 1.2s linear infinite;
}
#rollBox.cometActive::before{
  content:"";
  position:absolute; inset:-40%;
  background:
    repeating-linear-gradient(
      120deg,
      rgba(255,255,255,0) 0px,
      rgba(255,255,255,0) 16px,
      rgba(255,255,255,.35) 16px,
      rgba(255,255,255,.35) 18px,
      rgba(255,255,255,0) 18px,
      rgba(255,255,255,0) 38px
    );
  opacity:.25;
  animation:cometFall 0.9s linear infinite;
  pointer-events:none;
  z-index:1;
}

/* Storage overlay grid */
.storageTopRow{
  display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
  margin-bottom:10px;
}
.storageMeta{font-size:12px;color:#cfcfcf;line-height:1.3;}
.storageBtns{display:flex;gap:8px;align-items:center;}
.storageBtns button{
  border:1px solid #fff;background:none;color:#fff;
  border-radius:12px;padding:6px 10px;cursor:pointer;
}
#storageList{
  display:grid;
  grid-template-columns:repeat(5, minmax(0, 1fr));
  gap:8px;
}
.storageHint{
  margin-top:10px;
  font-size:12px;color:#cfcfcf;opacity:.9;
}
@media (max-width: 820px){
  #storageList{grid-template-columns:repeat(3, minmax(0, 1fr));}
}
/* =========================
   Run & Hide cutscene overlay
========================= */
#runHideFX{
  position:absolute;
  inset:0;
  pointer-events:none;
  z-index:1750;   /* acima do Severance (1600) */
  opacity:0;
  transition:opacity 120ms ease;
}
#runHideFX.show{ opacity:1; }

#runHideFX .rhDim{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,0.86);
}

#runHideFX .rhScan{
  position:absolute;
  inset:0;
  background:repeating-linear-gradient(
    0deg,
    rgba(255,255,255,0) 0px,
    rgba(255,255,255,0) 7px,
    rgba(255,255,255,.06) 7px,
    rgba(255,255,255,.06) 8px
  );
  opacity:.40;
  mix-blend-mode:screen;
  animation:rhScan 220ms linear infinite;
}

@keyframes rhScan{
  0%{ transform:translateY(-2%); }
  100%{ transform:translateY(2%); }
}

#runHideFX .rhWords{
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  font-size:64px;
  font-weight:900;
  letter-spacing:12px;
  opacity:0;
  color:#fff;
  text-shadow:
    0 0 18px rgba(255,255,255,.25),
    0 0 40px rgba(255,255,255,.10);
  animation:rhPulse 200ms ease-in-out infinite;
}

@keyframes rhPulse{
  0%,100%{ transform:translate(-50%,-50%) scale(1); opacity:.35; }
  50%{ transform:translate(-50%,-50%) scale(1.04); opacity:1; }
}
/* =========================
   MISSIONS UI
========================= */
#missionsPanel h2{margin:0 0 10px 0;font-size:18px;letter-spacing:1px;}

.missionsTop{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:10px;
  margin-bottom:10px;
}
.missionsMeta{
  font-size:12px;
  color:#cfcfcf;
  line-height:1.35;
}
.missionsTabs{
  display:flex;
  gap:10px;
  align-items:center;
}
.missionsTab{
  border:1px solid rgba(255,255,255,0.9);
  border-radius:12px;
  padding:6px 12px;
  font-size:12px;
  letter-spacing:0.6px;
  opacity:0.95;
}

.missionsLayout{
  display:grid;
  grid-template-columns: 1fr 0.95fr;
  gap:12px;
}
@media (max-width: 820px){
  .missionsLayout{grid-template-columns:1fr;}
}

.missionsList{
  border:1px solid var(--border);
  border-radius:14px;
  overflow:hidden;
}
.missionRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px;
  border-bottom:1px solid var(--border);
  cursor:pointer;
  background:rgba(0,0,0,0.25);
  transition:transform 0.12s ease, background 0.12s ease;
}
.missionRow:hover{transform:translateY(-1px); background:rgba(255,255,255,0.03);}
.missionRow:last-child{border-bottom:none;}

.missionLeft{
  display:flex;
  flex-direction:column;
  gap:4px;
  min-width:0;
}
.missionTitle{
  font-size:13px;
  font-weight:700;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.missionProg{
  font-size:12px;
  color:#cfcfcf;
}
.missionRight{
  display:flex;
  align-items:center;
  gap:10px;
}
.missionCheck{
  width:26px;height:26px;
  border-radius:8px;
  border:1px solid rgba(255,255,255,0.9);
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:900;
  font-size:16px;
  opacity:0.85;
}
.missionCheck.done{
  background:rgba(255,255,255,0.10);
  box-shadow:0 0 14px rgba(255,255,255,0.12);
  opacity:1;
}
.missionCheck.claimed{
  opacity:0.35;
}

.missionDetail{
  border:1px solid var(--border);
  border-radius:14px;
  padding:12px;
  background:rgba(0,0,0,0.22);
}
.missionDetail h3{
  margin:0 0 8px 0;
  font-size:14px;
  letter-spacing:0.5px;
}
.missionDetail .desc{
  font-size:12px;
  color:#cfcfcf;
  line-height:1.45;
  margin-bottom:10px;
}
.missionDetail .reward{
  font-size:12px;
  color:#eaeaea;
  border:1px dashed var(--border);
  border-radius:12px;
  padding:10px;
  margin-bottom:10px;
}
.missionDetail .reward b{letter-spacing:0.5px;}
.missionDetail .actions{
  display:flex;
  gap:8px;
}
.missionDetail button{
  border-radius:12px;
  border:1px solid white;
  background:none;
  color:white;
  cursor:pointer;
  padding:7px 10px;
  flex:1;
}
.missionDetail button:disabled{
  opacity:0.45;
  cursor:not-allowed;
}
</style>
</head>

<body>

<!-- Intro -->
<div id="introOverlay" aria-hidden="false">
  <div id="introMessage">This game is heavily inspired by Sols rng in Roblox.</div>
</div>

<!-- Name prompt overlay -->
<div id="nameOverlay" style="display:none;">
  <div class="nameBox">
    <div class="nameTitle">What's your name?</div>
    <input id="playerNameInput" maxlength="16" placeholder="Your name"/>
    <button onclick="confirmPlayerName()">Confirm</button>
  </div>
</div>

<div id="app">
  <div id="biomeFX"></div>
  <div id="whiteFlash"></div>

  <!-- Layers cutscene overlay -->
  <div id="layersSweep" aria-hidden="true">
    <div class="circle"></div>
    <div class="shade"></div>
    <div class="whiteBurst"></div>
  </div>
  

  <!-- Severance cutscene overlay -->
  <div id="severanceFX" aria-hidden="true">
    <div class="scan"></div>
    <div class="flash"></div>
    <div class="popLayer" id="sevPopLayer"></div>
  </div>

  <!-- Run & Hide cutscene overlay -->
 <div id="runHideFX" aria-hidden="true">
  <div class="rhDim"></div>
  <div class="rhScan"></div>
  <div class="rhWords" id="rhWords"></div>
 </div>


  <div id="left">
    <div id="rollingAurasTitle">ROLLING AURAS</div>
    <div id="rollingAuras"></div>
  </div>

  <div id="center">
    <div id="titleWrap">
      <div id="title">AN RNG SITE</div>
      <div id="subtitle">Realm's Expasion</div>
    </div>

    <div id="effectEquippedLabel">Effect Equipped: None</div>
    <div id="biomeLabel">Bioma: Natural</div>
    <div id="rollsLabel">Rolls: 0</div>

    <div id="rollBox">
      <div id="rolledAura">---</div>
      <div id="rolledRarity"></div>
      <div id="rolledMulti"></div>
      <div id="activePotions"></div>
    </div>

    <button id="rollBtn">ROLL</button>

    <!-- NEW: bonus counter above coins -->
    <div id="bonusLabel">0/10</div>

    <div id="coinsWrap">Coins: 0<span class="coinFloat" id="coinFloat">-0</span></div>

    <!-- NEW: current luck below coins -->
    <div id="currentLuck">Current Luck: x1.00 (+0%)</div>
  </div>

  <div id="right">
    <div class="effectBox" id="effectsList"></div>
  </div>

  <!-- STORAGE OVERLAY -->
  <div id="storageOverlay" class="overlay" aria-hidden="true">
    <button class="overlayClose" id="storageClose" title="Close" aria-label="Close">X</button>
    <div class="overlayPanel" id="storagePanel">
      <h2>STORAGE</h2>
      <div class="storageTopRow">
        <div>
          <div class="storageMeta" id="storageMeta">Slots: 0/0</div>
          <div class="storageMeta">Click aura to move back to Rolling.</div>
        </div>
        <div class="storageBtns">
          <button onclick="buyStorage()">Buy Slot (<span id="storageCostInStorage">50</span>)</button>
          <button onclick="buyAllStorage()">Buy All</button>
        </div>
      </div>
      <div id="storageList"></div>
      <div class="storageHint">Click auras in <b>ROLLING AURAS</b> to send to Storage. Slot limit still applies.</div>
    </div>
  </div>

  <!-- POTIONS OVERLAY -->
  <div id="potionsOverlay" class="overlay" aria-hidden="true">
    <button class="overlayClose" id="potionsClose" title="Close" aria-label="Close">X</button>
    <div class="overlayPanel" id="potionsPanel">
      <h2>POTIONS CRAFT</h2>
      <div id="potionsList"></div>
    </div>
  </div>
  <!-- MISSIONS OVERLAY -->
<div id="missionsOverlay" class="overlay" aria-hidden="true">
  <button class="overlayClose" id="missionsClose" title="Close" aria-label="Close">X</button>
  <div class="overlayPanel" id="missionsPanel">
    <h2>MISSIONS</h2>

    <div class="missionsTop">
      <div class="missionsMeta">
        <div class="missionsTabs">
          <div class="missionsTab">Daily</div>
        </div>
        <div id="missionsDateLine" style="margin-top:6px; opacity:.9;"></div>
        <div id="missionsRefreshLine" style="margin-top:2px;"></div>
      </div>
    </div>

    <div class="missionsLayout">
      <div class="missionsList" id="missionsList"></div>

      <div class="missionDetail" id="missionDetail">
        <h3>Select a mission</h3>
        <div class="desc">Click a mission on the left to see details and claim the reward.</div>
        <div class="reward"><b>Reward:</b> —</div>
        <div class="actions">
          <button disabled>Claim</button>
          <button disabled>Close</button>
        </div>
      </div>
    </div>
  </div>
</div>

  <!-- UPDATE LOG OVERLAY -->
  <div id="logOverlay" class="overlay" aria-hidden="true">
    <button class="overlayClose" id="logClose" title="Close" aria-label="Close">X</button>
    <div class="overlayPanel" id="logPanel">
      <h2>UPDATE LOG / GAME GUIDE</h2>

      <div class="logSection">
        <h3>Luck (hidden)</h3>
        <ul>
          <li>Every 10 rolls: +0.5% luck (not shown).</li>
        </ul>
      </div>

      <div class="logSection">
        <h3>New Auras (Patch 1.1 draft)</h3>
        <ul>
          <li><b>Phantom</b>: 1 in 278.</li>
          <li><b>Overture</b> (Time Mutation): 1 in 60000.</li>
          <li><b>Archangel</b>: 1 in 35000.</li>
          <li><b>Bloodmoon</b>: 1 in 79000.</li>
          <li><b>Eclipse</b>: new aura visual (half Blaze + Night).</li>
        </ul>
      </div>

      <div class="logSection">
        <h3>New Biomes</h3>
        <ul>
          <li><b>Desert</b>: has Sand / Tempest / Prague in its pool.</li>
          <li><b>Rain</b>: -15% rarity (better) for ALL auras with effects + Storage cost 25.</li>
        </ul>
      </div>

      <div class="logSection">
        <h3>Biomes FX</h3>
        <ul>
          <li><b>Inferno</b>: tiny invisible pops.</li>
          <li><b>Windstorm</b>: wind behind UI.</li>
          <li><b>Sky Realm</b>: angelical white tint (very subtle).</li>
          <li><b>Zero</b>: invert colors.</li>
          <li><b>Aurora</b>: faint colored background.</li>
          <li><b>Desert</b>: sand drift behind UI.</li>
          <li><b>Rain</b>: subtle rain streaks (hard to see).</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- shared open/close anim -->
  <div id="panelAnim"></div>
</div>


<script>
/* =========================
   WebAudio sfx
========================= */
let audioCtx = null;
function ensureAudio(){
  if(audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}
function sfx(type="click"){
  if(!audioCtx) return;
  const now = audioCtx.currentTime;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.connect(g); g.connect(audioCtx.destination);

  let freq = 260;
  let dur  = 0.06;
  if(type==="roll"){freq=420;dur=0.08;}
  if(type==="biome"){freq=520;dur=0.09;}
  if(type==="open"){freq=360;dur=0.12;}
  if(type==="close"){freq=220;dur=0.12;}
  if(type==="coin"){freq=610;dur=0.08;}
  if(type==="rare"){freq=740;dur=0.10;}
  if(type==="super"){freq=980;dur=0.12;}
  if(type==="galaxy"){freq=1200;dur=0.16;}
  if(type==="glitch"){freq=140;dur=0.22;}
  if(type==="lev"){freq=520;dur=0.14;}

  o.type = "sine";
  o.frequency.setValueAtTime(freq, now);

  g.gain.setValueAtTime(0.0001, now);
  g.gain.exponentialRampToValueAtTime(0.09, now+0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, now+dur);

  o.start(now);
  o.stop(now+dur);
}

/* =========================
   Persistence
========================= */
const SAVE_KEY = "an_rng_site_save_v10_desert_rain_newauras";
function saveGame(){
  try{
    const data = {
      version: 11,

      coins,
      storageLimit,
      rolling,
      storage,

      crafted,
      craftProgress,
      effects,

      potionInventory,
      potionProgress,

      activePotionTimers,
      auroraPotionArmed,
      legendaryPotionArmed,

      rollCount,

      biomeChanceMultiplier,
      pendingPaperBoostMs,
      currentBiome,
      biomeEndTime,

      bonusCounter,
      bonusArmed,

      // MISSIONS (daily)
      missionsState,
      dailyKey,
      dailyRolls,
      dailyCometRolls,
      dailyLuckyUsed,
      dailyPlayMs,
      dailyExplored
    };

    localStorage.setItem(SAVE_KEY, JSON.stringify(data));
  }catch(e){}
}

function loadGame(){
  try{
    const raw = localStorage.getItem(SAVE_KEY);
    if(!raw) return;

    const data = JSON.parse(raw);

    coins = data.coins ?? coins;
    storageLimit = data.storageLimit ?? storageLimit;
    rolling = data.rolling ?? rolling;
    storage = data.storage ?? storage;

    crafted = data.crafted ?? crafted;
    craftProgress = data.craftProgress ?? craftProgress;
    effects = data.effects ?? effects;

    potionInventory = data.potionInventory ?? potionInventory;

    // Potion progress can be missing in older saves; keep shape safe
    if(data.potionProgress){
      potionProgress = data.potionProgress;
    }

    activePotionTimers = data.activePotionTimers ?? activePotionTimers;
    auroraPotionArmed = data.auroraPotionArmed ?? auroraPotionArmed;
    legendaryPotionArmed = data.legendaryPotionArmed ?? legendaryPotionArmed;

    rollCount = data.rollCount ?? rollCount;

    biomeChanceMultiplier = data.biomeChanceMultiplier ?? biomeChanceMultiplier;
    pendingPaperBoostMs = data.pendingPaperBoostMs ?? pendingPaperBoostMs;
    currentBiome = data.currentBiome ?? currentBiome;
    biomeEndTime = data.biomeEndTime ?? biomeEndTime;

    bonusCounter = data.bonusCounter ?? bonusCounter;
    bonusArmed = data.bonusArmed ?? bonusArmed;

    // MISSIONS (daily)
    if(data.missionsState) missionsState = data.missionsState;

    dailyKey = data.dailyKey ?? dailyKey;
    dailyRolls = data.dailyRolls ?? dailyRolls;
    dailyCometRolls = data.dailyCometRolls ?? dailyCometRolls;
    dailyLuckyUsed = data.dailyLuckyUsed ?? dailyLuckyUsed;
    dailyPlayMs = data.dailyPlayMs ?? dailyPlayMs;
    dailyExplored = data.dailyExplored ?? dailyExplored;
  }catch(e){}
}

/* =========================
   AURAS
========================= */
const aurasData=[
  {name:'Layers', rarity:17250, layers:true},
  {name:'Universe', rarity:2100, universe:true},
  {name:'Galaxy', rarity:1200, galaxy:true},
  {name:'Comet', rarity:725, comet:true},

  /* NEW auras */
  {name:'Phantom', rarity:278, phantom:true},
  {name:'Overture', rarity:60000, overture:true},
  {name:'Archangel', rarity:35000, archangel:true},
  {name:'Bloodmoon', rarity:79000, bloodmoon:true},

  {name:'Legendary', rarity:500, legendary:true},
  {name:'Money', rarity:600, money:true},
  {name:'Web', rarity:1500, web:true},
  {name:'Balance', rarity:1425, balance:true},
  {name:'Chromatic', rarity:20000, chromatic:true},
  {name:'Severance', rarity:12000, severance:true},
  {name:'Leviathan', rarity:15000, leviathan:true},
  {name:'Good', rarity:5, good:true},

  {name:'Natural', rarity:8},
  {name:'Common', rarity:2},
  {name:'Incommun', rarity:5},
  {name:'Rare', rarity:50},

  {name:'Topaz',rarity:150},
  {name:'Windy',rarity:100},
  {name:'Worth',rarity:700},
  {name:'Paper',rarity:500},
  {name:'Alt',rarity:999},
  {name:'Unknowm',rarity:1000},

  {name:'Sol',rarity:5000},
  {name:'Lua',rarity:5000},
  {name:'Dimensional',rarity:1000},

  {name:'Nebula',rarity:300},
  {name:'Photon',rarity:250, photon:true},
  {name:'Eclipse',rarity:1000, eclipseFx:true}, /* Eclipse now has style */
  {name:'SINGULARITY',rarity:100000},
  {name:'TIME',rarity:100},

  {name:'Night',rarity:100},
  {name:'Blaze',rarity:100},
  {name:'Windstorm',rarity:50},
  {name:'Rage',rarity:125},

  {name:'Magma',rarity:250},
  {name:'Light',rarity:500},

  {name:'Looping',rarity:500},
  {name:'Faster',rarity:250},

  {name:'Hunter',rarity:225, hunter:true},
  {name:'Sound',rarity:400}
];

const zeroAurasData = [
  {name:'Null', rarity:1},
  {name:'None', rarity:5},
  {name:'Deep', rarity:25},
  {name:'Anomaly', rarity:50},
  {name:'Abyssal', rarity:250},
  {name:'Limbo', rarity:500},
  {name:'Undefined', rarity:915},
  {name:'Nullscape', rarity:1000},
  {name:'Elude', rarity:299999},
  {name:"I'm here?", rarity:500000},
  {name:'Narcospace', rarity:999999},
  {name:'Run & Hide', rarity:1000000}
];

const auroraAurasData = [
  {name:'Prism', rarity:50},
  {name:'Exotic', rarity:942},
  {name:'Borealis', rarity:200},
  {name:'Ascend', rarity:725},
  {name:'Realm', rarity:250},
  {name:'Everything', rarity:1000000},
  {name:'CybeDivine', rarity:250000}
];

/* NEW: Desert biome auras */
const desertAurasData = [
  {name:'Sand', rarity:25, sand:true},
  {name:'Tempest', rarity:2500, tempest:true},
  {name:'Prague', rarity:721, prague:true},
];

/* =========================
   STATE
========================= */
let rolling=[], storage=[], effects=[], crafted={
  Windstorm:false,
  Lumi:false,
  CometBlessing:false,
  GalaxySpace:false,
  UniverseBreaths:false,
  Timing:false,
  Sunshine:false,
  FullMoon:false,
  Eclipse:false,
  PureHate:false
};

let craftProgress={
  Windstorm:{Common:0,Incommun:0,Windy:0,Windstorm:0},
  Lumi:{Light:0,Common:0,Incommun:0},

  CometBlessing:{Comet:0, Light:0, Windstorm:0},

  GalaxySpace:{Galaxy:0, Dimensional:0, CometBlessing:0},

  UniverseBreaths:{Universe:0, Comet:0, Galaxy:0},

  Timing:{TIME:0,Topaz:0,Alt:0,Photon:0},
  Sunshine:{Sol:0,Rare:0,Blaze:0},
  FullMoon:{Lua:0,Rare:0,Night:0},
  Eclipse:{Sunshine:0,FullMoon:0,Eclipse:0},
  PureHate:{Rage:0,Blaze:0,Hunter:0}
};

let coins=0, storageLimit=5, rollingLock=false, rollCount=0;

/* NEW: 0/10 -> 2X ROLL system */
let bonusCounter = 0;     // 0..9
let bonusArmed = false;   // when true => shows "2X ROLL" and next roll gets 1.5x luck

/* =========================
   BIOMES
========================= */
let currentBiome='Natural';
let biomeEndTime=0;

let biomeChanceMultiplier = 1;
let pendingPaperBoostMs = 0;

function isBiomeActive(){ return biomeEndTime && Date.now() < biomeEndTime; }

function applyBiomeFXClass(){
  const app = document.getElementById('app');
  app.classList.remove(
    'biomeOn',
    'biomeInferno','biomeWindstorm','biomeSky','biomeZero','biomeAurora',
    'biomeDesert','biomeRain'
  );

  if(isBiomeActive() && currentBiome !== 'Natural'){
    app.classList.add('biomeOn');
    if(currentBiome === 'Inferno') app.classList.add('biomeInferno');
    if(currentBiome === 'Windstorm') app.classList.add('biomeWindstorm');
    if(currentBiome === 'Sky Realm') app.classList.add('biomeSky');
    if(currentBiome === 'Zero') app.classList.add('biomeZero');
    if(currentBiome === 'Aurora') app.classList.add('biomeAurora');

    if(currentBiome === 'Desert') app.classList.add('biomeDesert');
    if(currentBiome === 'Rain') app.classList.add('biomeRain');
  }
}

function setBiome(name, durationMs){
  currentBiome = name;
  // daily explore tracking
ensureDailyMissions();
if(name === "Desert") dailyExplored.Desert = true;
if(name === "Zero") dailyExplored.Zero = true;
if(name === "Windstorm") dailyExplored.Windstorm = true;
if(name === "Chrono") dailyExplored.Chrono = true;

const mo = document.getElementById("missionsOverlay");
if(mo && mo.classList.contains("show")) renderMissions();

  if(pendingPaperBoostMs > 0){
    durationMs += pendingPaperBoostMs;
    pendingPaperBoostMs = 0;
  }

  biomeEndTime = Date.now() + durationMs;

  const el = document.getElementById('biomeLabel');
  el.classList.remove('shake'); void el.offsetWidth; el.classList.add('shake');

  sfx("biome");
  pulseUI(el);
  updateBiomeLabel();
  applyBiomeFXClass();
  saveGame();
}

function endBiome(){
  currentBiome = 'Natural';
  biomeEndTime = 0;
  updateBiomeLabel();
  applyBiomeFXClass();
}

function updateBiomeLabel(){
  const el = document.getElementById('biomeLabel');

  if(isBiomeActive()){
    const leftMs = Math.max(0, biomeEndTime - Date.now());
    if(currentBiome === 'Zero'){
      el.innerText = `Bioma: ${currentBiome}`;
      return;
    }
    const totalSec = Math.ceil(leftMs/1000);
    const m = Math.floor(totalSec/60);
    const s = String(totalSec%60).padStart(2,'0');
    el.innerText = `Bioma: ${currentBiome} (${m}:${s})`;
    return;
  }else{
    if(biomeEndTime){ endBiome(); }
  }
  el.innerText = `Bioma: ${currentBiome}`;
}
setInterval(updateBiomeLabel, 250);

/*
  Regras (interpretando seu pedido):
  - Desert: chance 25% (bem comum)
  - Rain: "terceiro mais comum" -> deixei como 20% (abaixo de Desert e Sky Realm)
*/
const BIOME_RULES = [
  {name:'Zero', interval:30000, chance:0.001, duration:120000},
  {name:'Aurora', interval:30000, chance:0.005, duration:120000},

  {name:'Desert', interval:30000, chance:0.25, duration:90000},   // NEW
  {name:'Sky Realm', interval:60000, chance:0.30, duration:90000},
  {name:'Rain', interval:30000, chance:0.20, duration:90000},     // NEW
  {name:'Windstorm', interval:30000, chance:0.18, duration:90000},
  {name:'Inferno', interval:30000, chance:0.16, duration:90000},

  {name:'Chrono', interval:60000, chance:0.08, duration:90000},
];

let biomeTick = 0;
let biomeMasterInterval = null;

function startBiomeSchedulers(){
  if(biomeMasterInterval) clearInterval(biomeMasterInterval);

  biomeMasterInterval = setInterval(()=>{
    if(isBiomeActive()) return;

    if(Math.random() < 0.50){
      endBiome();
      return;
    }

    biomeTick++;

    for(const rule of BIOME_RULES){
      if(rule.interval === 60000 && (biomeTick % 2 !== 0)) continue;

      const ch = rule.chance * biomeChanceMultiplier;
      if(Math.random() < ch){
        setBiome(rule.name, rule.duration);
        return;
      }
    }

    endBiome();
  }, 30000);
}

/* =========================
   UI helpers
========================= */
function pulseUI(el){
  el.classList.remove('pulseUI');
  void el.offsetWidth;
  el.classList.add('pulseUI');
  setTimeout(()=>el.classList.remove('pulseUI'), 600);
}
function bounceButton(btn){
  btn.classList.remove('btnBounce');
  void btn.offsetWidth;
  btn.classList.add('btnBounce');
  setTimeout(()=>btn.classList.remove('btnBounce'), 320);
}
document.addEventListener('click', (e)=>{
  ensureAudio();
  const btn = e.target.closest('button');
  if(btn){
    bounceButton(btn);
    sfx("click");
  }
});

/* =========================
   Shared overlay anim
========================= */
function playPanelAnimOpen(){
  const anim = document.getElementById('panelAnim');
  anim.classList.remove('closing');
  anim.classList.add('opening');
  sfx("open");
  pulseUI(document.getElementById('titleWrap'));
  setTimeout(()=> anim.classList.remove('opening'), 560);
}
function playPanelAnimClose(){
  const anim = document.getElementById('panelAnim');
  anim.classList.remove('opening');
  anim.classList.add('closing');
  sfx("close");
  setTimeout(()=> anim.classList.remove('closing'), 560);
}

/* =========================
   RollBox FX helpers
========================= */
function pulseRollBoxFX(type){
  const rb = document.getElementById('rollBox');
  rb.classList.remove('galaxyActive','cometActive','universeActive');
  void rb.offsetWidth;
  rb.classList.add(type);
  setTimeout(()=> rb.classList.remove(type), 1800);
}
function shakeAppLight(){
  const app = document.getElementById('app');
  app.classList.remove('shakeLight');
  void app.offsetWidth;
  app.classList.add('shakeLight');
  setTimeout(()=> app.classList.remove('shakeLight'), 560);
}
function shakeAppHard(){
  const app = document.getElementById('app');
  app.classList.remove('shakeHard');
  void app.offsetWidth;
  app.classList.add('shakeHard');
  setTimeout(()=> app.classList.remove('shakeHard'), 560);
}
function shakeAppMega(durationMs=500){
  const start = Date.now();
  const tick = ()=>{
    shakeAppHard();
    if(Date.now() - start < durationMs){
      setTimeout(tick, 110);
    }
  };
  tick();
}
function leviathanFireBorders(){
  const app = document.getElementById('app');
  app.classList.remove('leviathanBurn');
  void app.offsetWidth;
  app.classList.add('leviathanBurn');
  setTimeout(()=> app.classList.remove('leviathanBurn'), 520);
}

function spawnGalaxyExplosion(kind="galaxy"){
  const rollBox = document.getElementById('rollBox');
  const e = document.createElement('div');
  e.className = 'explosion ' + (kind === "universe" ? 'universe' : 'galaxy');
  rollBox.appendChild(e);

  const max = (kind==="universe") ? 820 : 640;
  const step = (kind==="universe") ? 46 : 34;
  let size = 0;
  let opacity = 1.0;

  const interval = setInterval(()=>{
    size += step;
    opacity -= (kind==="universe") ? 0.045 : 0.05;
    e.style.width = Math.min(size, max) + 'px';
    e.style.height = Math.min(size, max) + 'px';
    e.style.opacity = Math.max(0, opacity);
    if(opacity <= 0){
      clearInterval(interval);
      e.remove();
    }
  }, 16);
}

/* =========================
   Layers cutscene
========================= */
let layersSwap = false;
function startLayersCutscene(onReveal){
  const sweep = document.getElementById('layersSweep');
  sweep.classList.remove('sweep','burst');
  sweep.classList.add('show');
  sweep.setAttribute('aria-hidden','false');

  shakeAppLight();

  setTimeout(()=>{ sweep.classList.add('sweep'); }, 40);
  setTimeout(()=>{ shakeAppHard(); }, 820);
  setTimeout(()=>{ sweep.classList.add('burst'); }, 1320);

  setTimeout(()=>{
    if(typeof onReveal === "function") onReveal();
  }, 1460);

  setTimeout(()=>{
    sweep.classList.remove('show','sweep','burst');
    sweep.setAttribute('aria-hidden','true');
  }, 2800);
}
function startRunHideCutscene(onReveal){
  const fx = document.getElementById('runHideFX');
  const words = document.getElementById('rhWords');

  fx.classList.add('show');
  fx.setAttribute('aria-hidden','false');

  const seq = ["RUN", "HIDE", "RUN", "HIDE"];
  let i = 0;

  const timer = setInterval(()=>{
    words.textContent = seq[i % seq.length];
    words.style.opacity = "1";
    i++;
  }, 200);

  setTimeout(()=>{
    clearInterval(timer);
    fx.classList.remove('show');
    fx.setAttribute('aria-hidden','true');
    if(typeof onReveal === "function") onReveal();
  }, 1200);
}


/* =========================
   Severance cutscene
========================= */
let sevPopTimer=null;
function clearSevPopups(){
  const layer = document.getElementById('sevPopLayer');
  layer.innerHTML = "";
  if(sevPopTimer){ clearInterval(sevPopTimer); sevPopTimer=null; }
}
function spawnSevPopup(){
  const layer = document.getElementById('sevPopLayer');
  const p = document.createElement('div');
  p.className = 'sevPop';

  const x = Math.random() * 78 + 4;
  const y = Math.random() * 72 + 6;
  p.style.left = x + '%';
  p.style.top = y + '%';

  const w = Math.floor(140 + Math.random()*170);
  const h = Math.floor(70 + Math.random()*110);
  p.style.width = w + 'px';
  p.style.height = h + 'px';

  const rot = (Math.random()*10 - 5).toFixed(1);
  p.style.transform = `rotate(${rot}deg)`;

  layer.appendChild(p);
  setTimeout(()=>{ p.remove(); }, 650);
}
function startSeveranceCutscene(onReveal){
  const fx = document.getElementById('severanceFX');
  fx.classList.add('show');
  fx.setAttribute('aria-hidden','false');

  sfx("glitch");

  clearSevPopups();
  sevPopTimer = setInterval(()=>{
    for(let i=0;i<4;i++) spawnSevPopup();
  }, 90);

  setTimeout(()=>{
    clearSevPopups();
    fx.classList.remove('show');
    fx.setAttribute('aria-hidden','true');

    const app = document.getElementById('app');
    app.classList.remove('sevZoom');
    void app.offsetWidth;
    app.classList.add('sevZoom');

    if(typeof onReveal === "function") onReveal();

    setTimeout(()=> app.classList.remove('sevZoom'), 900);
  }, 500);
}

/* =========================
   Storage & Rolling UI
========================= */
function renderAuraBox(div, aura){
  div.className='auraBox';
  div.style.color='';
  div.style.textShadow='';
  div.innerHTML='';

  if(aura.name==='TIME'){
    div.innerHTML=`<span class="timeAuraBox">${aura.name}</span>`;
    return;
  }
  if(aura.layers){
    div.innerHTML = `<span class="layersAuraBox ${layersSwap ? 'layersSwapB':'layersSwapA'}">${aura.name}</span>`;
    return;
  }
  if(aura.chromatic || aura.name==='Chromatic'){
    const sp = document.createElement('span');
    sp.className = 'chromaticAuraBox chromaLive';
    sp.textContent = aura.name;
    div.appendChild(sp);
    return;
  }

  /* NEW auras */
  if(aura.overture || aura.name==='Overture'){
    div.classList.add('overtureAuraBox');
    div.innerText = aura.name;
    return;
  }
  if(aura.archangel || aura.name==='Archangel'){
    div.classList.add('archangelAuraBox');
    div.innerText = aura.name;
    return;
  }
  if(aura.bloodmoon || aura.name==='Bloodmoon'){
    div.classList.add('bloodmoonAuraBox');
    div.innerText = aura.name;
    return;
  }
  if(aura.phantom || aura.name==='Phantom'){
    div.classList.add('phantomAuraBox');
    div.innerText = aura.name;
    return;
  }

  /* Desert auras */
  if(aura.sand || aura.name==='Sand'){
    div.classList.add('sandAuraBox');
    div.innerText = aura.name;
    return;
  }
  if(aura.tempest || aura.name==='Tempest'){
    div.classList.add('tempestAuraBox');
    div.innerText = aura.name;
    return;
  }
  if(aura.prague || aura.name==='Prague'){
    div.classList.add('pragueAuraBox');
    div.innerText = aura.name;
    return;
  }

  if(aura.leviathan || aura.name==='Leviathan'){
    div.classList.add('leviathanAuraBox');
    div.innerText = aura.name;
    return;
  }
  if(aura.severance || aura.name==='Severance'){
    div.classList.add('severanceAuraBox');
    div.innerText = aura.name;
    return;
  }
  if(aura.web || aura.name==='Web'){
    div.classList.add('webAuraBox');
    div.innerText = aura.name;
    return;
  }
  if(aura.money || aura.name==='Money'){
    div.classList.add('moneyAuraBox');
    div.innerText = aura.name;
    return;
  }

  /* Legendary in Rolling/Storage keeps the rotating halo */
  if(aura.legendary || aura.name==='Legendary'){
    div.classList.add('legendaryAuraBox');
    div.innerText = aura.name;
    return;
  }

  if(aura.balance || aura.name==='Balance'){
    div.classList.add('balanceAuraBox');
    div.innerText = aura.name;
    return;
  }
  if(aura.photon || aura.name==='Photon'){
    div.classList.add('photonAuraBox');
    div.innerText = aura.name;
    return;
  }
  if(aura.universe){
    div.classList.add('universeAuraBox');
    div.innerText = aura.name;
    return;
  }
  if(aura.galaxy){
    div.classList.add('galaxyAuraBox');
    div.innerText = aura.name;
    return;
  }
  if(aura.comet){
    div.classList.add('cometAuraBox');
    div.innerText = aura.name;
    return;
  }
  if(aura.name==='Night'){
    div.classList.add('nightAuraBox');
    div.innerText=aura.name;
    return;
  }
  if(aura.name==='Blaze'){
    div.classList.add('blazeAuraBox');
    div.innerText=aura.name;
    return;
  }
  if(aura.name==='Light'){
    div.style.color='#fff';
    div.style.textShadow='0 0 8px #fff,0 0 16px #fff';
    div.innerText=aura.name;
    return;
  }
  if(aura.name==='Eclipse'){
    div.classList.add('eclipseAuraBox');
    div.innerText=aura.name;
    return;
  }
  if(aura.hunter || aura.name==='Hunter'){
    div.classList.add('hunterAuraBox');
    div.innerText=aura.name;
    return;
  }

  div.innerText=aura.name;
}

function refreshRolling(){
  const el=document.getElementById('rollingAuras'); el.innerHTML='';
  const start = rolling.length>14 ? rolling.length-14 : 0;
  rolling.slice(start).forEach((a,i)=>{
    const d=document.createElement('div');
    renderAuraBox(d,a);
    d.title = "Click to move to Storage";
    d.onclick=()=>moveToStorage(start+i);
    el.appendChild(d);
  });
}

function renderStorageOverlay(){
  const meta = document.getElementById('storageMeta');
  meta.innerText = `Slots: ${storage.length}/${storageLimit}`;

  const list = document.getElementById('storageList');
  list.innerHTML='';

  const cost=storageSlotCost();
  document.getElementById('storageCostInStorage').innerText = String(cost);

  if(storage.length === 0){
    const p = document.createElement('div');
    p.style.gridColumn = "1 / -1";
    p.style.padding = "10px";
    p.style.border = "1px dashed var(--border)";
    p.style.borderRadius = "14px";
    p.style.color = "#cfcfcf";
    p.style.fontSize = "12px";
    p.innerHTML = "Storage empty. Click auras in <b>ROLLING AURAS</b> to store them.";
    list.appendChild(p);
    return;
  }

  storage.forEach((a,i)=>{
    const d=document.createElement('div');
    renderAuraBox(d,a);
    d.title = "Click to move back to Rolling";
    d.onclick=()=>moveToRolling(i);
    list.appendChild(d);
  });
}

function refreshStorage(){ renderStorageOverlay(); }

function moveToStorage(i){
  if(storage.length>=storageLimit) return;
  storage.push(rolling[i]);
  rolling.splice(i,1);
  refreshRolling();
  refreshStorage();
  renderPotions(); renderActivePotions();
  saveGame();
}
function moveToRolling(i){
  rolling.push(storage[i]);
  storage.splice(i,1);
  refreshRolling();
  refreshStorage();
  renderPotions(); renderActivePotions();
  saveGame();
}

/* =========================
   SHOP
========================= */
function floatCoins(amount){
  const el = document.getElementById('coinFloat');
  el.textContent = (amount<0? `${amount}` : `+${amount}`);
  el.style.opacity = '0';
  el.style.transform = 'translateY(0px)';
  void el.offsetWidth;
  el.style.opacity = '1';
  el.style.transform = 'translateY(-10px)';
  el.style.transition = 'opacity 260ms ease, transform 260ms ease';
  setTimeout(()=>{
    el.style.opacity = '0';
    el.style.transform = 'translateY(-18px)';
  }, 260);
}

/* NEW: Rain biome gives storage cost 25 (discount) */
function storageSlotCost(){
  if(currentBiome === 'Rain' && isBiomeActive()) return 25;
  return (effects.includes('FullMoon')||effects.includes('Eclipse'))?25:50;
}

function buyStorage(){
  const cost=storageSlotCost();
  if(coins<cost) return;

  sfx("coin");
  pulseUI(document.getElementById('coinsWrap'));
  floatCoins(-cost);

  coins -= cost;
  storageLimit++;
  updateCoinsUI();
  renderEffects();
  refreshStorage();
  saveGame();
}

function buyAllStorage(){
  const cost = storageSlotCost();
  if(cost <= 0) return;
  const qty = Math.floor(coins / cost);
  if(qty <= 0) return;

  sfx("coin");
  pulseUI(document.getElementById('coinsWrap'));
  floatCoins(-(qty*cost));

  coins -= qty*cost;
  storageLimit += qty;

  updateCoinsUI();
  renderEffects();
  refreshStorage();
  saveGame();
}

function updateCoinsUI(){
  const wrap = document.getElementById('coinsWrap');
  wrap.innerText = `Coins: ${coins}`;
  if(!document.getElementById('coinFloat')){
    const sp = document.createElement('span');
    sp.className = 'coinFloat';
    sp.id = 'coinFloat';
    sp.textContent='-0';
    wrap.appendChild(sp);
  }else{
    wrap.appendChild(document.getElementById('coinFloat'));
  }
}

/* =========================
   BONUS LABEL + CURRENT LUCK
========================= */
function updateBonusLabel(){
  const el = document.getElementById('bonusLabel');
  el.innerText = bonusArmed ? "2X ROLL" : `${bonusCounter}/10`;
}
function getVisibleLuckPercent(){
  let pct = 0;
  if(effects.includes('Windstorm')) pct += 50;
  if(effects.includes('Lumi')) pct += 100;
  if(effects.includes('CometBlessing')) pct += 250;
  if(effects.includes('GalaxySpace')) pct += 425;
  if(effects.includes('UniverseBreaths')) pct += 625;

  if(luckyActive) pct += 100;
  if(hunterPotionActive) pct += 350;

  return pct;
}
function updateCurrentLuckUI(extraMultiplier=1){
  const pct = getVisibleLuckPercent();
  const mult = 1 + (pct / 100);
  const el = document.getElementById('currentLuck');
  const m = (mult * extraMultiplier);
  el.innerText = `Current Luck: x${m.toFixed(2)} (+${pct}%)`;
}

/* =========================
   EFFECTS
========================= */
const allEffects = [
  'Windstorm',
  'Lumi',
  'CometBlessing',
  'GalaxySpace',
  'UniverseBreaths',
  'Timing',
  'Sunshine',
  'FullMoon',
  'Eclipse',
  'PureHate'
];

function equipEffect(e){
  let maxEffects=(effects.includes('Sunshine')||effects.includes('Eclipse'))?3:2;
  if(!effects.includes(e) && effects.length<maxEffects) effects.push(e);
  renderEffects(); updateEquipped(); updateCurrentLuckUI(bonusArmed?1.5:1); saveGame();
}
function unequipEffect(e){
  effects=effects.filter(x=>x!==e);
  renderEffects(); updateEquipped(); updateCurrentLuckUI(bonusArmed?1.5:1); saveGame();
}
function updateEquipped(){
  const el=document.getElementById('effectEquippedLabel');
  el.innerText = effects.length ? `Effect Equipped: ${effects.join(', ')}` : 'Effect Equipped: None';
}

function getEffectNeeds(){
  return {
    Windstorm:{Common:5,Incommun:1,Windy:3,Windstorm:1},
    Lumi:{Light:1,Common:25,Incommun:15},

    CometBlessing:{Comet:1, Light:5, Windstorm:50},

    GalaxySpace:{Galaxy:1, Dimensional:1, CometBlessing:1},

    UniverseBreaths:{Universe:1, Comet:5, Galaxy:1},

    Timing:{TIME:1,Topaz:5,Alt:1,Photon:3},
    Sunshine:{Sol:1,Rare:15,Blaze:1},
    FullMoon:{Lua:1,Rare:15,Night:1},
    Eclipse:{Sunshine:1,FullMoon:1,Eclipse:1},
    PureHate:{Rage:50,Blaze:25,Hunter:5}
  };
}

function addToCraft(effect){
  const needs = getEffectNeeds();
  const eNeed = needs[effect];
  if(!eNeed) return;

  if(effect === "GalaxySpace" && eNeed.CometBlessing){
    if(crafted.CometBlessing){
      craftProgress.GalaxySpace.CometBlessing = 1;
    }
  }

  for(const aura in eNeed){
    if(aura === "CometBlessing") continue;

    let required = eNeed[aura] - (craftProgress[effect]?.[aura] ?? 0);
    let inStorage = storage.filter(x=>x.name===aura).length;
    let toAdd = Math.min(required,inStorage);

    if(toAdd>0){
      for(let i=0;i<storage.length && toAdd>0;i++){
        if(storage[i].name===aura){
          storage.splice(i,1);
          toAdd--;
          craftProgress[effect][aura] = (craftProgress[effect][aura] ?? 0) + 1;
          i--;
        }
      }
    }
  }

  let done = true;
  for(const aura in eNeed){
    if((craftProgress[effect][aura] ?? 0) < eNeed[aura]) done=false;
  }

  if(done){
    crafted[effect] = true;

    if(effect === "GalaxySpace"){
      crafted.CometBlessing = false;
      craftProgress.CometBlessing = {Comet:0, Light:0, Windstorm:0};
      effects = effects.filter(x=>x!=="CometBlessing");
      updateEquipped();
    }
  }

  refreshStorage(); renderEffects(); updateEquipped(); renderPotions();
  updateCurrentLuckUI(bonusArmed?1.5:1);
  saveGame();
}

function renderEffects(){
  const needs = getEffectNeeds();
  const box=document.getElementById('effectsList');

 box.innerHTML=`
  <button class="buyStorageBtn" onclick="openLog()">Update Log</button>
  <button class="buyStorageBtn" onclick="openMissions()">Missions</button>
  <button class="buyStorageBtn" onclick="openStorage()">Storage</button>
  <button class="buyStorageBtn" onclick="openPotions()">Open Potions Craft</button>
`;


  allEffects.forEach(effect=>{
    let html=`<b>${effect}</b>`;
    switch(effect){
      case 'Windstorm': html+=`<br>+50% Luck<br>-10% Roll Speed`; break;
      case 'Lumi': html+=`<br>+100% Luck<br>-25% Roll Speed`; break;
      case 'CometBlessing': html+=`<br>+250% Luck`; break;
      case 'GalaxySpace': html+=`<br>+425% Luck<br>-5% Roll Speed`; break;
      case 'UniverseBreaths': html+=`<br>+625% Luck<br>+25% Roll Speed`; break;
      case 'Timing': html+=`<br>-35% Rolling... delay`; break;
      case 'Sunshine': html+=`<br>Use 3 effects at the same time`; break;
      case 'FullMoon': html+=`<br>Storage discount, storage cost 25 coins`; break;
      case 'Eclipse': html+=`<br>Combine Sunshine + Full Moon benefits`; break;
      case 'PureHate': html+=`<br>+35%: 2 auras<br>+15%: 3 auras`; break;
    }

    const needLine = Object.keys(needs[effect]).map(a=>{
      const left = Math.max(0, needs[effect][a] - (craftProgress[effect]?.[a] ?? 0));
      return `${left} ${a}`;
    }).join(', ');

    html+=`<div class="counter">Needs: ${needLine}</div>`;

    if(!crafted[effect]){
      html+=`<button onclick="addToCraft('${effect}')">Add</button>`;
    }else{
      html+=`<button onclick="equipEffect('${effect}')">Equip</button>`;
      html+=`<button onclick="unequipEffect('${effect}')">Unequip</button>`;
    }

    const div=document.createElement('div');
    div.innerHTML=html;
    box.appendChild(div);
  });
}

/* =========================
   POTIONS
========================= */
const POTIONS = [
  { id:'LuckyPotion',  name:'Lucky Potion',  symbol:'☘︎', durationMs:60000, desc:'+100% luck for 1 minute.', needs:{Common:15, Coins:100} },

  { id:'QuickPotion',  name:'Quick Potion',  symbol:'∞',  durationMs:60000, desc:'Auto roll (no clicking) for 1 minute.', needs:{Looping:1, Worth:5, Common:500} },

  { id:'FasterPotion', name:'Faster Potion', symbol:'∞',  bright:true, durationMs:60000, desc:'Hide “Rolling...” and -50% cooldown for 1 minute.', needs:{Faster:1, Looping:5, Alt:10, Worth:15} },

  { id:'AuroraPotion', name:'Aurora Potion', symbol:'⚙︎', durationMs:0, desc:'Next roll guarantees rarity > 500.', needs:{Prism:25, Exotic:15, Realm:5} },
  { id:'NebulaPotion', name:'Nebula Potion', symbol:'✦', durationMs:30000, desc:'For 30s: can only roll rarity > 50.', needs:{Nebula:5, Prism:1} },

  { id:'DimensionalPotion', name:'Dimensional Potion', symbol:'◇', durationMs:0, desc:'Spawn a biome instantly (overrides current). Then biome spawn chances become ×0.25.', needs:{Dimensional:1} },
  { id:'HunterPotion', name:'Hunter Potion', symbol:'☠︎', durationMs:60000, desc:'+350% luck for 1 minute.', needs:{Hunter:1, Rage:25, Common:50} },
  { id:'PaperPotion', name:'Paper Potion', symbol:'▢', durationMs:0, desc:'+1 minute biome duration (current or next).', needs:{Paper:1, Common:50} },

  { id:'LegendaryPotion', name:'Legendary Potion', symbol:'✪', durationMs:0, desc:'Next roll guarantees rarity > 500.', needs:{Legendary:1, Money:5, Common:15} },
];

let potionInventory = {
  LuckyPotion:0, QuickPotion:0, FasterPotion:0, AuroraPotion:0, NebulaPotion:0,
  DimensionalPotion:0, HunterPotion:0, PaperPotion:0,
  LegendaryPotion:0
};
let potionProgress = {};
function initPotionProgress(){
  potionProgress = {};
  POTIONS.forEach(p=>{
    potionProgress[p.id] = {};
    Object.keys(p.needs).forEach(a=> potionProgress[p.id][a]=0);
  });
}
initPotionProgress();

let activePotionTimers = {
  LuckyPotion:0, QuickPotion:0, FasterPotion:0, NebulaPotion:0,
  HunterPotion:0
};
let auroraPotionArmed=false;
let legendaryPotionArmed=false;

let luckyActive=false;
let fasterActive=false;
let nebulaPotionActive=false;
let hunterPotionActive=false;
let quickInterval=null;

function countInStorage(auraName){ return storage.filter(a=>a.name===auraName).length; }
function removeManyFromStorage(auraName, count){
  let removed = 0;
  for(let i=0;i<storage.length && removed<count;i++){
    if(storage[i].name===auraName){
      storage.splice(i,1);
      removed++;
      i--;
    }
  }
  return removed;
}
function remainingForPotion(p){
  const rem = {};
  for(const k of Object.keys(p.needs)){
    rem[k] = Math.max(0, p.needs[k] - (potionProgress[p.id][k]||0));
  }
  return rem;
}
function canCraftPotion(p){
  for(const k of Object.keys(p.needs)){
    if((potionProgress[p.id][k]||0) < p.needs[k]) return false;
  }
  return true;
}

function addOneToPotion(potionId){
  const p = POTIONS.find(x=>x.id===potionId);
  if(!p) return;

  const rem = remainingForPotion(p);
  let chosen=null;

  for(const k of Object.keys(p.needs)){
    if(rem[k] <= 0) continue;

    if(k === "Coins"){
      if(coins > 0){ chosen = "Coins"; break; }
      continue;
    }
    if(countInStorage(k) > 0){
      chosen = k; break;
    }
  }

  if(!chosen) return;

  if(chosen === "Coins"){
    coins -= 1;
    potionProgress[potionId].Coins += 1;
    updateCoinsUI();
    floatCoins(-1);
  }else{
    const removed = removeManyFromStorage(chosen, 1);
    if(removed === 1){
      potionProgress[potionId][chosen] += 1;
      refreshStorage();
    }
  }

  renderPotions();
  saveGame();
}

function addAllToPotion(potionId){
  const p = POTIONS.find(x=>x.id===potionId);
  if(!p) return;

  const rem = remainingForPotion(p);
  let changed = false;

  for(const k of Object.keys(p.needs)){
    const needLeft = rem[k] || 0;
    if(needLeft <= 0) continue;

    if(k === "Coins"){
      const take = Math.min(coins, needLeft);
      if(take > 0){
        coins -= take;
        potionProgress[potionId].Coins += take;
        updateCoinsUI();
        floatCoins(-take);
        changed = true;
      }
      continue;
    }

    const inStor = countInStorage(k);
    const take = Math.min(inStor, needLeft);
    if(take > 0){
      const removed = removeManyFromStorage(k, take);
      potionProgress[potionId][k] += removed;
      changed = true;
    }
  }

  if(changed){
    refreshStorage();
    renderPotions();
    saveGame();
  }
}

function craftPotion(potionId){
  const p = POTIONS.find(x=>x.id===potionId);
  if(!p) return;
  if(!canCraftPotion(p)) return;

  potionInventory[potionId] = (potionInventory[potionId]||0) + 1;
  Object.keys(p.needs).forEach(k=> potionProgress[potionId][k]=0);

  renderPotions();
  saveGame();
}

function forceSpawnRandomBiome(){
  let total = 0;
  for(const r of BIOME_RULES) total += (r.chance * biomeChanceMultiplier);

  let pick = Math.random() * total;
  let cum = 0;
  for(const r of BIOME_RULES){
    cum += (r.chance * biomeChanceMultiplier);
    if(pick <= cum){
      setBiome(r.name, r.duration);
      return;
    }
  }
  const fb = BIOME_RULES[0];
  setBiome(fb.name, fb.duration);
}

function usePotion(potionId){
  if((potionInventory[potionId]||0) <= 0) return;
  ensureDailyMissions();
if(potionId === "LuckyPotion") dailyLuckyUsed++;
const mo = document.getElementById("missionsOverlay");
if(mo && mo.classList.contains("show")) renderMissions();

  // consume 1 potion on use
  potionInventory[potionId] = Math.max(0, (potionInventory[potionId]||0) - 1);
  renderPotions();
  saveGame();

  if(potionId === 'LegendaryPotion'){
    legendaryPotionArmed = true;
    renderActivePotions();
    renderPotions();
    saveGame();
    return;
  }

  if(potionId === 'AuroraPotion'){
    auroraPotionArmed = true;
    renderActivePotions();
    renderPotions();
    saveGame();
    return;
  }

  if(potionId === 'PaperPotion'){
    const addMs = 60000;
    if(isBiomeActive() && currentBiome !== 'Natural'){
      biomeEndTime += addMs;
      updateBiomeLabel();
      applyBiomeFXClass();
    }else{
      pendingPaperBoostMs += addMs;
    }
    renderPotions();
    saveGame();
    return;
  }

  if(potionId === 'DimensionalPotion'){
    forceSpawnRandomBiome();
    biomeChanceMultiplier = 0.25;
    renderPotions();
    saveGame();
    return;
  }

  const p = POTIONS.find(x=>x.id===potionId);
  if(!p) return;

  activePotionTimers[potionId] = p.durationMs;

  if(potionId==='LuckyPotion') luckyActive=true;
  if(potionId==='FasterPotion') fasterActive=true;
  if(potionId==='NebulaPotion') nebulaPotionActive=true;
  if(potionId==='HunterPotion') hunterPotionActive=true;

  if(potionId==='QuickPotion'){
    if(quickInterval) clearInterval(quickInterval);
    quickInterval = setInterval(()=> rollAura(), 120);
  }

  renderActivePotions();
  renderPotions();
  updateCurrentLuckUI((bonusArmed?1.5:1));
  saveGame();

  setTimeout(()=>{
    if(potionId==='LuckyPotion') luckyActive=false;
    if(potionId==='FasterPotion') fasterActive=false;
    if(potionId==='NebulaPotion') nebulaPotionActive=false;
    if(potionId==='HunterPotion') hunterPotionActive=false;

    if(potionId==='QuickPotion'){
      if(quickInterval){ clearInterval(quickInterval); quickInterval=null; }
    }
    activePotionTimers[potionId]=0;
    renderActivePotions();
    renderPotions();
    updateCurrentLuckUI((bonusArmed?1.5:1));
    saveGame();
  }, p.durationMs);
}

function displayNeedName(k){
  if(k === "Common") return "Commun";
  return k;
}

function renderPotions(){
  const list = document.getElementById('potionsList');
  list.innerHTML='';

  POTIONS.forEach(p=>{
    const inv = potionInventory[p.id] || 0;

    const remainingText = Object.keys(p.needs).map(k=>{
      const need = p.needs[k];
      const prog = potionProgress[p.id][k] || 0;
      const left = Math.max(0, need - prog);
      return `${left} ${displayNeedName(k)}`;
    }).join(', ');

    const card = document.createElement('div');
    card.className='potionCard';
    card.innerHTML = `
      <div class="potionRow">
        <div style="flex:1">
          <div class="potionName">${p.name} <span style="opacity:.8">(${p.bright ? '✨' : ''}${p.symbol})</span></div>
          <div class="potionDesc">${p.desc}</div>
          <div class="potionNeeds">Remaining: ${remainingText}</div>
          <div class="potionNeeds">Inventory: ${inv}</div>
        </div>
        <div class="potionActions">
          <button onclick="addAllToPotion('${p.id}')">Add all</button>
          <button onclick="addOneToPotion('${p.id}')">Add</button>
          <button class="secondary" onclick="craftPotion('${p.id}')">Craft</button>
          <button onclick="usePotion('${p.id}')">Use</button>
        </div>
      </div>
    `;
    list.appendChild(card);
  });
}

function renderActivePotions(){
  const el = document.getElementById('activePotions');
  el.innerHTML='';

  for(const id of Object.keys(activePotionTimers)){
    const ms = activePotionTimers[id] || 0;
    if(ms <= 0) continue;
    const p = POTIONS.find(x=>x.id===id);
    if(!p) continue;

    const mini = document.createElement('div');
    mini.className = 'potionMini' + (p.bright ? ' glow' : '');
    mini.innerHTML = `<span class="sym">${p.bright ? '✨' : ''}${p.symbol}</span><span>${Math.ceil(ms/1000)}s</span>`;
    el.appendChild(mini);
  }

  if(auroraPotionArmed){
    const p = POTIONS.find(x=>x.id==='AuroraPotion');
    const mini = document.createElement('div');
    mini.className = 'potionMini';
    mini.innerHTML = `<span class="sym">${p.symbol}</span><span>x1</span>`;
    el.appendChild(mini);
  }
  if(legendaryPotionArmed){
    const p = POTIONS.find(x=>x.id==='LegendaryPotion');
    const mini = document.createElement('div');
    mini.className = 'potionMini glow';
    mini.innerHTML = `<span class="sym">${p.symbol}</span><span>x1</span>`;
    el.appendChild(mini);
  }
}

/* potion countdown */
setInterval(()=>{
  let changed=false;
  for(const id of Object.keys(activePotionTimers)){
    if(activePotionTimers[id] > 0){
      activePotionTimers[id] = Math.max(0, activePotionTimers[id] - 1000);
      changed=true;
    }
  }
  if(changed) renderActivePotions();
},1000);

/* =========================
   Overlays
========================= */
function openPotions(){
  playPanelAnimOpen();
  setTimeout(()=>{
    const overlay=document.getElementById('potionsOverlay');
    overlay.classList.add('show');
    overlay.setAttribute('aria-hidden','false');
    renderPotions();
  }, 260);
}
function closePotions(){
  const overlay=document.getElementById('potionsOverlay');
  overlay.classList.remove('show');
  overlay.setAttribute('aria-hidden','true');
  playPanelAnimClose();
}
document.getElementById('potionsClose').onclick = closePotions;
document.getElementById('potionsOverlay').addEventListener('click',(e)=>{
  if(e.target.id==='potionsOverlay') closePotions();
});

function openStorage(){
  playPanelAnimOpen();
  setTimeout(()=>{
    const overlay=document.getElementById('storageOverlay');
    overlay.classList.add('show');
    overlay.setAttribute('aria-hidden','false');
    renderStorageOverlay();
  }, 260);
}
function closeStorage(){
  const overlay=document.getElementById('storageOverlay');
  overlay.classList.remove('show');
  overlay.setAttribute('aria-hidden','true');
  playPanelAnimClose();
}
document.getElementById('storageClose').onclick = closeStorage;
document.getElementById('storageOverlay').addEventListener('click',(e)=>{
  if(e.target.id==='storageOverlay') closeStorage();
});

function openLog(){
  const overlay=document.getElementById('logOverlay');
  overlay.classList.add('show');
  overlay.setAttribute('aria-hidden','false');
  sfx("open");
}
function closeLog(){
  const overlay=document.getElementById('logOverlay');
  overlay.classList.remove('show');
  overlay.setAttribute('aria-hidden','true');
  sfx("close");
}
document.getElementById('logClose').onclick = closeLog;
document.getElementById('logOverlay').addEventListener('click',(e)=>{
  if(e.target.id==='logOverlay') closeLog();
});

/* =========================
   BIOME roll rules
========================= */
function isAuraWithEffects(a){
  return !!(
    a.layers || a.universe || a.galaxy || a.comet || a.legendary ||
    a.money || a.web || a.balance || a.chromatic || a.severance || a.leviathan ||
    a.good || a.photon || a.hunter ||
    a.phantom || a.overture || a.archangel || a.bloodmoon ||
    a.eclipseFx ||
    a.sand || a.tempest || a.prague
  );
}

function biomeAdjustedRarity(a){
  let r = a.rarity;

  if(currentBiome === 'Inferno' && a.name === 'Rage') r = 12;
  if(currentBiome === 'Windstorm' && (a.name === 'Windy' || a.name === 'Windstorm')) r = 5;
  if(currentBiome === 'Sky Realm') r = Math.max(1, Math.round(r * 0.75));

  /* NEW: Rain => ALL auras with effects get rarity reduced by 15% (better) */
  if(currentBiome === 'Rain' && isBiomeActive() && isAuraWithEffects(a)){
    r = Math.max(1, Math.round(r * 0.85));
  }

  return r;
}

/* Desert picker: desert auras + base; commons heavily reduced */
function pickDesert(){
  const baseHigh = aurasData.filter(a => a.rarity > 100);
  const baseLow  = aurasData.filter(a => a.rarity <= 100);

  const LOW_MULT = 0.03; // commons almost don't appear
  const poolA = desertAurasData;

  let total = 0;
  for(const a of poolA) total += (1 / biomeAdjustedRarity(a));
  for(const a of baseHigh) total += (1 / biomeAdjustedRarity(a));
  for(const a of baseLow) total += (1 / biomeAdjustedRarity(a)) * LOW_MULT;

  let r = Math.random() * total;
  let cum = 0;

  for(const a of poolA){
    cum += (1 / biomeAdjustedRarity(a));
    if(r <= cum) return {...a, rarity: biomeAdjustedRarity(a)};
  }
  for(const a of baseHigh){
    cum += (1 / biomeAdjustedRarity(a));
    if(r <= cum) return {...a, rarity: biomeAdjustedRarity(a)};
  }
  for(const a of baseLow){
    cum += (1 / biomeAdjustedRarity(a)) * LOW_MULT;
    if(r <= cum) return {...a, rarity: biomeAdjustedRarity(a)};
  }

  const fallback = poolA[0];
  return {...fallback, rarity: biomeAdjustedRarity(fallback)};
}

function pickAurora(){
  const baseHigh = aurasData.filter(a => a.rarity > 100);
  const baseLow  = aurasData.filter(a => a.rarity <= 100);

  const LOW_MULT = 0.02;
  const poolA = auroraAurasData;

  let total = 0;
  for(const a of poolA) total += (1 / biomeAdjustedRarity(a));
  for(const a of baseHigh) total += (1 / biomeAdjustedRarity(a));
  for(const a of baseLow) total += (1 / biomeAdjustedRarity(a)) * LOW_MULT;

  let r = Math.random() * total;
  let cum = 0;

  for(const a of poolA){
    cum += (1 / biomeAdjustedRarity(a));
    if(r <= cum) return {...a, rarity: biomeAdjustedRarity(a)};
  }
  for(const a of baseHigh){
    cum += (1 / biomeAdjustedRarity(a));
    if(r <= cum) return {...a, rarity: biomeAdjustedRarity(a)};
  }
  for(const a of baseLow){
    cum += (1 / biomeAdjustedRarity(a)) * LOW_MULT;
    if(r <= cum) return {...a, rarity: biomeAdjustedRarity(a)};
  }

  const fallback = poolA[0];
  return {...fallback, rarity: biomeAdjustedRarity(fallback)};
}

function weightedPick(pool){
  let candidates = pool;

  if(currentBiome === 'Sky Realm' && isBiomeActive()){
    candidates = candidates.filter(a => a.name !== 'Common');
    if(!candidates.length) candidates = pool;
  }

  if(nebulaPotionActive){
    candidates = candidates.filter(a => biomeAdjustedRarity(a) > 50);
    if(!candidates.length) candidates = pool;
  }

  let total = 0;
  for(const a of candidates){
    total += (1 / biomeAdjustedRarity(a));
  }

  let r = Math.random() * total;
  let cum = 0;
  for(const a of candidates){
    cum += (1 / biomeAdjustedRarity(a));
    if(r <= cum) return {...a, rarity: biomeAdjustedRarity(a)};
  }
  const fb = candidates[0];
  return {...fb, rarity: biomeAdjustedRarity(fb)};
}

function pickOneAura(){
  // se não estiver ativo, sempre volta pro pool normal
  if(!isBiomeActive() || currentBiome === 'Natural'){
    return weightedPick(aurasData);
  }

  if(currentBiome === 'Zero'){
    return weightedPick(aurasData.concat(zeroAurasData));
  }
  if(currentBiome === 'Aurora'){
    return pickAurora();
  }
  if(currentBiome === 'Desert'){
    return pickDesert();
  }
  return weightedPick(aurasData);
}

/* =========================
   LUCK SYSTEM
========================= */
function getHiddenLuckPercent(){
  return Math.floor(rollCount / 10) * 0.5;
}

function getTotalLuckMultiplier(extraMultiplier=1){
  let pct = 0;

  if(effects.includes('Windstorm')) pct += 50;
  if(effects.includes('Lumi')) pct += 100;
  if(effects.includes('CometBlessing')) pct += 250;
  if(effects.includes('GalaxySpace')) pct += 425;
  if(effects.includes('UniverseBreaths')) pct += 625;

  if(luckyActive) pct += 100;
  if(hunterPotionActive) pct += 350;

  pct += getHiddenLuckPercent();

  const base = 1 + (pct / 100);
  return base * extraMultiplier;
}

function pickWithLuckMultiplier(extraMultiplier=1){
  const mult = getTotalLuckMultiplier(extraMultiplier);

  let attempts = Math.max(1, Math.floor(mult));
  const frac = mult - Math.floor(mult);
  if(Math.random() < frac) attempts += 1;

  attempts = Math.min(attempts, 24);

  let best = null;
  for(let i=0;i<attempts;i++){
    const a = pickOneAura();
    if(!best || a.rarity > best.rarity) best = a;
  }
  return best;
}

/* Legendary potion guarantee: rarity > 500 */
function pickWithLegendaryPotionGuarantee(){
  if(!legendaryPotionArmed) return null;
  legendaryPotionArmed = false;
  renderActivePotions();

  let pool = aurasData;
  if(currentBiome === 'Zero') pool = aurasData.concat(zeroAurasData);
  if(currentBiome === 'Aurora') pool = auroraAurasData.concat(aurasData);
  if(currentBiome === 'Desert') pool = desertAurasData.concat(aurasData);

  let candidates = pool.filter(a => biomeAdjustedRarity(a) > 500);
  if(!candidates.length) return pickWithLuckMultiplier(1);
  return weightedPick(candidates);
}

/* Aurora potion guarantee: rarity > 500 */
function pickWithAuroraPotionGuarantee(){
  if(!auroraPotionArmed) return null;
  auroraPotionArmed = false;
  renderActivePotions();

  let pool = aurasData;
  if(currentBiome === 'Zero') pool = aurasData.concat(zeroAurasData);
  if(currentBiome === 'Aurora') pool = auroraAurasData.concat(aurasData);
  if(currentBiome === 'Desert') pool = desertAurasData.concat(aurasData);

  let candidates = pool.filter(a => biomeAdjustedRarity(a) > 500);
  if(!candidates.length) return pickWithLuckMultiplier(1);
  return weightedPick(candidates);
}

/* =========================
   Explosions
========================= */
function spawnSparkSmall(){
  const rollBox = document.getElementById('rollBox');
  const sp = document.createElement('div');
  sp.className = 'spark';
  rollBox.appendChild(sp);

  let size=0;
  let opacity=0.55;
  const max=90;

  const id=setInterval(()=>{
    size += 10;
    opacity -= 0.06;
    sp.style.width = Math.min(size,max) + 'px';
    sp.style.height = Math.min(size,max) + 'px';
    sp.style.opacity = Math.max(0,opacity);
    if(opacity<=0){
      clearInterval(id);
      sp.remove();
    }
  }, 16);
}

function spawnExplosion(type){
  const rollBox = document.getElementById('rollBox');
  const e = document.createElement('div');
  e.className = 'explosion' + (type==='super' ? ' super' : '');
  rollBox.appendChild(e);

  const max = (type==='super') ? 520 : 320;
  const step = (type==='super') ? 26 : 18;
  let size = 0;
  let opacity = (type==='super') ? 1.0 : 0.72;

  const interval = setInterval(()=>{
    size += step;
    opacity -= (type==='super') ? 0.045 : 0.032;
    e.style.width = Math.min(size, max) + 'px';
    e.style.height = Math.min(size, max) + 'px';
    e.style.opacity = Math.max(0, opacity);
    if(opacity <= 0){
      clearInterval(interval);
      e.remove();
    }
  }, 16);
}

function flashWhiteScreen(){
  const wf = document.getElementById('whiteFlash');
  wf.style.opacity = '0';
  void wf.offsetWidth;
  wf.style.opacity = '1';
  setTimeout(()=>{ wf.style.opacity = '0'; }, 140);
}

/* =========================
   Roll
========================= */
document.getElementById('rollBtn').onclick = ()=>rollAura();

function getMultiRollCount(){
  if(!effects.includes('PureHate')) return 1;
  const r = Math.random();
  if(r < 0.15) return 3;
  if(r < 0.15 + 0.35) return 2;
  return 1;
}

function getCooldownMultiplier(){
  let m = 1;

  if(effects.includes('Windstorm')) m *= 0.90;
  if(effects.includes('Lumi')) m *= 0.75;
  if(effects.includes('GalaxySpace')) m *= 0.95;

  if(effects.includes('UniverseBreaths')) m *= 0.75;

  if(fasterActive) m *= 0.50;

  return m;
}

function getRollingDelayMs(){
  let d = 500;

  if(effects.includes('Timing')) d = Math.round(d * 0.65);

  const chrono = (currentBiome === 'Chrono' && isBiomeActive());
  if(fasterActive || chrono) d = 0;

  return d;
}

function setRolledText(aura){
  const rolledEl=document.getElementById('rolledAura');
  rolledEl.className='';
  rolledEl.style.color = '';
  rolledEl.style.textShadow = '';
  rolledEl.innerHTML = '';

  if(aura.layers){
    layersSwap = !layersSwap;
    rolledEl.innerHTML = `<span class="layersAuraBox ${layersSwap ? 'layersSwapB':'layersSwapA'}">${aura.name}</span>`;
    return;
  }

  if(aura.chromatic || aura.name==='Chromatic'){
    const sp = document.createElement('span');
    sp.className = 'chromaticAuraBox chromaLive';
    sp.textContent = aura.name;
    rolledEl.appendChild(sp);
    return;
  }

  rolledEl.textContent = aura.name;

  if(aura.phantom || aura.name==='Phantom') rolledEl.classList.add('phantomAuraBox');
  if(aura.overture || aura.name==='Overture') rolledEl.classList.add('overtureAuraBox');
  if(aura.archangel || aura.name==='Archangel') rolledEl.classList.add('archangelAuraBox');
  if(aura.bloodmoon || aura.name==='Bloodmoon') rolledEl.classList.add('bloodmoonAuraBox');

  if(aura.sand || aura.name==='Sand') rolledEl.classList.add('sandAuraBox');
  if(aura.tempest || aura.name==='Tempest') rolledEl.classList.add('tempestAuraBox');
  if(aura.prague || aura.name==='Prague') rolledEl.classList.add('pragueAuraBox');

  if(aura.hunter || aura.name==='Hunter') rolledEl.classList.add('hunterAuraBox');
  if(aura.universe) rolledEl.classList.add('universeAuraBox');
  if(aura.galaxy) rolledEl.classList.add('galaxyAuraBox');
  if(aura.comet) rolledEl.classList.add('cometAuraBox');

  if(aura.photon || aura.name==='Photon') rolledEl.classList.add('photonAuraBox');
  if(aura.money || aura.name==='Money') rolledEl.classList.add('moneyAuraBox');
  if(aura.web || aura.name==='Web') rolledEl.classList.add('webAuraBox');
  if(aura.balance || aura.name==='Balance') rolledEl.classList.add('balanceAuraBox');

  if(aura.legendary || aura.name==='Legendary') rolledEl.classList.add('legendaryNoHalo');

  if(aura.name==='Eclipse') rolledEl.classList.add('eclipseAuraBox');

  if(aura.severance || aura.name==='Severance') rolledEl.classList.add('severanceAuraBox');
  if(aura.leviathan || aura.name==='Leviathan') rolledEl.classList.add('leviathanAuraBox');
}

/* =========================
   Chromatic warm color cycler
========================= */
const WARM_COLORS = [
  "#ff2a2a", "#ff6a00", "#ffb000", "#ffd36a", "#ff2ad4", "#ff3b5c", "#ff7a1a"
];
function stepChromatic(){
  const nodes = document.querySelectorAll('.chromaLive');
  nodes.forEach(n=>{
    const c = WARM_COLORS[Math.floor(Math.random()*WARM_COLORS.length)];
    n.style.color = c;
    n.style.textShadow = `0 0 10px ${c}55, 0 0 22px ${c}22`;
  });
}
setInterval(stepChromatic, 220);

/* =========================
   Main Roll
========================= */
async function rollAura(){
  if(rollingLock) return;

  const chrono = (currentBiome === 'Chrono' && isBiomeActive());
  rollingLock = true;

  const rollBtn=document.getElementById('rollBtn');
  const rolledEl=document.getElementById('rolledAura');
  const rarityEl=document.getElementById('rolledRarity');
  const multiEl=document.getElementById('rolledMulti');

  const bonusThisRoll = bonusArmed;
  const bonusLuckMult = bonusThisRoll ? 2 : 1;

  spawnSparkSmall();
  sfx("roll");

  rolledEl.className='';
  rolledEl.textContent = (!fasterActive && !chrono) ? "Rolling..." : "";
  rarityEl.textContent = "";
  multiEl.textContent = "";
  rollBtn.classList.add('disabled');

  const delay = getRollingDelayMs();

  setTimeout(()=>{
    const pickedList = [];
    const count = getMultiRollCount();

    for(let i=0;i<count;i++){
      let picked = pickWithLegendaryPotionGuarantee();
      if(!picked) picked = pickWithAuroraPotionGuarantee();
      if(!picked) picked = pickWithLuckMultiplier(bonusLuckMult);
      pickedList.push(picked);
      rolling.push(picked);
    }

    const first = pickedList[0];

    if(first.name === 'Severance'){
      rolledEl.textContent = "Rolling...";
      rarityEl.textContent = "";
      multiEl.textContent = "";

      startSeveranceCutscene(()=>{
        setRolledText(first);
        rarityEl.textContent = `Rarity: ${first.rarity}`;
        rolledEl.classList.add('rollAnim');
        setTimeout(()=>rolledEl.classList.remove('rollAnim'),500);
      });
    }
    else if(first.name === 'Run & Hide'){
  rolledEl.textContent = "Rolling...";
  rarityEl.textContent = "";
  multiEl.textContent = "";

  startRunHideCutscene(()=>{
    setRolledText(first);
    rarityEl.textContent = `Rarity: ${first.rarity}`;
    rolledEl.classList.add('rollAnim');
    setTimeout(()=>rolledEl.classList.remove('rollAnim'),500);
  });
}

    else if(first.layers){
      rolledEl.textContent = "Rolling...";
      rarityEl.textContent = "";
      multiEl.textContent = "";

      startLayersCutscene(()=>{
        setRolledText(first);
        rarityEl.textContent = `Rarity: ${first.rarity}`;
        rolledEl.classList.add('rollAnim');
        setTimeout(()=>rolledEl.classList.remove('rollAnim'),500);
      });
    }
    else{
      setRolledText(first);
      rarityEl.textContent = `Rarity: ${first.rarity}`;

      if(pickedList.length > 1){
        multiEl.textContent = pickedList.map((p,idx)=> `${idx+1}) ${p.name} (${p.rarity})`).join("\n");
      }

      if(first.name === 'Leviathan'){
        sfx("lev");
        leviathanFireBorders();
        shakeAppMega(500);
        flashWhiteScreen();
        spawnExplosion('super');
      }

      if(first.universe){
        sfx("galaxy");
        pulseRollBoxFX('universeActive');
        shakeAppHard();
        spawnGalaxyExplosion("universe");
        flashWhiteScreen();
      }else if(first.name === 'Galaxy'){
        sfx("galaxy");
        pulseRollBoxFX('galaxyActive');
        shakeAppLight();
        spawnGalaxyExplosion("galaxy");
      }else if(first.name === 'Comet'){
        pulseRollBoxFX('cometActive');
      }

      const best = pickedList.reduce((mx,p)=> Math.max(mx, p.rarity), 0);

      if(best > 100000){
        sfx("super");
        flashWhiteScreen();
        spawnExplosion('super');
      }else if(best > 1000){
        sfx("super");
        spawnExplosion('super');
      }else if(best > 100){
        sfx("rare");
        spawnExplosion('normal');
      }else if(first.name === 'Legendary'){
        sfx("rare");
        spawnExplosion('normal');
      }

      rolledEl.classList.add('rollAnim');
      setTimeout(()=>rolledEl.classList.remove('rollAnim'),500);
    }

    refreshRolling();
    rollCount++;
    document.getElementById('rollsLabel').innerText=`Rolls: ${rollCount}`;
    ensureDailyMissions();
dailyRolls++;

for(const p of pickedList){
  if(p.name === "Comet") dailyCometRolls++;
}

const mo = document.getElementById("missionsOverlay");
if(mo && mo.classList.contains("show")) renderMissions();


    coins += 5;
    updateCoinsUI();

    // ---- BONUS COUNTER LOGIC ----
    if(bonusThisRoll){
      bonusArmed = false;
      bonusCounter = 0;
      updateBonusLabel();
    }else{
      bonusCounter = Math.min(10, bonusCounter + 1);
      if(bonusCounter >= 10){
        bonusArmed = true;
      }
      if(bonusArmed) bonusCounter = 0;
      updateBonusLabel();
    }

    updateCurrentLuckUI(bonusArmed ? 1.5 : 1);

    if(chrono){
      rollingLock=false;
      rollBtn.classList.remove('disabled');
      saveGame();
      return;
    }

    const cooldownMs = Math.max(0, Math.round(1000 * getCooldownMultiplier()));

    rollingLock=false;
    setTimeout(()=>rollBtn.classList.remove('disabled'), cooldownMs);
    saveGame();
  }, delay);
}

/* =========================
   Expose to window
========================= */
window.openLog = openLog;
window.openPotions = openPotions;
window.openStorage = openStorage;

window.buyStorage = buyStorage;
window.buyAllStorage = buyAllStorage;

window.addOneToPotion = addOneToPotion;
window.addAllToPotion = addAllToPotion;
window.craftPotion = craftPotion;
window.usePotion = usePotion;

window.addToCraft = addToCraft;
window.equipEffect = equipEffect;
window.unequipEffect = unequipEffect;
/* =========================
   MISSIONS (Daily)
========================= */
function todayKey(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}
function formatTodayLine(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `Daily Missions | ${yyyy}.${mm}.${dd}`;
}
function msToMidnight(){
  const now = new Date();
  const nxt = new Date(now);
  nxt.setHours(24,0,0,0);
  return Math.max(0, nxt - now);
}
function formatHMS(ms){
  const s = Math.ceil(ms/1000);
  const h = Math.floor(s/3600);
  const m = Math.floor((s%3600)/60);
  const ss = String(s%60).padStart(2,'0');
  if(h>0) return `${h}h ${m}m ${ss}s`;
  return `${m}m ${ss}s`;
}

/* daily tracked stats */
let dailyKey = todayKey();
let dailyRolls = 0;
let dailyCometRolls = 0;
let dailyLuckyUsed = 0;
let dailyPlayMs = 0;
let dailyExplored = { Desert:false, Zero:false, Windstorm:false, Chrono:false };

let missionsState = {
  dateKey: dailyKey,
  picks: [],          // 3 mission ids
  claimed: {},        // id:true
  selectedId: null
};

/* Mission definitions */
const MISSIONS_POOL = [
  {
    id:"roll_comet_5",
    title:"Roll 5 Comet",
    type:"comet_rolls",
    target:5,
    reward:{ potions:{LuckyPotion:1} },
    desc:"Track cosmic trails. Find Comet auras to stabilize your luck stream."
  },
  {
    id:"use_lucky_1",
    title:"Use 1 Lucky Potion",
    type:"use_potion",
    potionId:"LuckyPotion",
    target:1,
    reward:{ coins:500 },
    desc:"A quick blessing. Use a Lucky Potion once to prove you're ready."
  },
  {
    id:"roll_500",
    title:"Roll 500 times",
    type:"rolls",
    target:500,
    reward:{ potions:{FasterPotion:1} },
    desc:"Endurance test. Keep rolling until the system recognizes your persistence."
  },
  {
    id:"roll_100",
    title:"Roll 100 times",
    type:"rolls",
    target:100,
    reward:{ potions:{FasterPotion:3} },
    desc:"Warm up your RNG engine. 100 rolls to unlock accelerated crafting."
  },
  {
    id:"explore_desert",
    title:"Explore Desert Biome",
    type:"explore_biome",
    biome:"Desert",
    target:1,
    reward:{ potions:{PaperPotion:1} },
    desc:"Sandstorm protocols. Enter Desert at least once today."
  },
  {
    id:"explore_zero_rare",
    title:"Explore Zero Biome",
    type:"explore_biome",
    biome:"Zero",
    target:1,
    reward:{ potions:{LegendaryPotion:5, NebulaPotion:1} },
    weight:0.12, // raríssima no sorteio das missões
    desc:"A forbidden inversion. Reach Zero and survive the colorless silence."
  },
  {
    id:"explore_windstorm",
    title:"Explore Windstorm Biome",
    type:"explore_biome",
    biome:"Windstorm",
    target:1,
    reward:{ coins:50 },
    desc:"Ride the winds. Enter Windstorm at least once today."
  },
  {
    id:"explore_chrono",
    title:"Explore Chrono Biome",
    type:"explore_biome",
    biome:"Chrono",
    target:1,
    reward:{ potions:{QuickPotion:1, FasterPotion:5} },
    desc:"Temporal instability detected. Enter Chrono to sync your timeline."
  },
  {
    id:"reach_1000_coins",
    title:"Reach 1000 Coins",
    type:"coins_reach",
    target:1000,
    reward:{ potions:{LegendaryPotion:1} },
    desc:"Financial calibration. Accumulate 1000 coins at once."
  },
  {
    id:"play_10_min",
    title:"Play for 10 minutes",
    type:"play_time",
    targetMs:10*60*1000,
    reward:{ coins:100 },
    desc:"Stay online and keep the RNG flowing for 10 minutes."
  },
  {
    id:"play_30_min",
    title:"Play for 30 minutes",
    type:"play_time",
    targetMs:30*60*1000,
    reward:{ coins:1000 },
    desc:"Long run session. Play for 30 minutes without giving up."
  },
];

function getMissionDef(id){
  return MISSIONS_POOL.find(m=>m.id===id);
}
function rewardText(rew){
  const parts = [];
  if(rew.coins) parts.push(`${rew.coins} Coins`);
  if(rew.potions){
    for(const k of Object.keys(rew.potions)){
      const amt = rew.potions[k];
      const p = POTIONS.find(x=>x.id===k);
      parts.push(`${amt} ${p ? p.name : k}`);
    }
  }
  return parts.join(", ");
}

function missionProgress(def){
  if(!def) return {cur:0, max:1, done:false};

  if(def.type === "comet_rolls"){
    const cur = dailyCometRolls;
    return {cur, max:def.target, done: cur>=def.target};
  }
  if(def.type === "use_potion"){
    const cur = dailyLuckyUsed; // só tem Lucky por enquanto
    return {cur, max:def.target, done: cur>=def.target};
  }
  if(def.type === "rolls"){
    const cur = dailyRolls;
    return {cur, max:def.target, done: cur>=def.target};
  }
  if(def.type === "explore_biome"){
    const hit = !!dailyExplored[def.biome];
    return {cur: hit?1:0, max:1, done: hit};
  }
  if(def.type === "coins_reach"){
    const cur = coins;
    return {cur, max:def.target, done: cur>=def.target};
  }
  if(def.type === "play_time"){
    const cur = dailyPlayMs;
    return {cur, max:def.targetMs, done: cur>=def.targetMs, isTime:true};
  }
  return {cur:0, max:1, done:false};
}

/* weighted random picks (no repeat) */
function pickDailyMissions(){
  const picks = [];
  const pool = MISSIONS_POOL.slice();

  const weightOf = (m)=> (typeof m.weight === "number" ? m.weight : 1);

  while(picks.length < 3 && pool.length){
    let total = 0;
    for(const m of pool) total += weightOf(m);

    let r = Math.random() * total;
    let idx = 0;
    for(; idx<pool.length; idx++){
      r -= weightOf(pool[idx]);
      if(r <= 0) break;
    }
    const chosen = pool.splice(Math.min(idx, pool.length-1), 1)[0];
    picks.push(chosen.id);
  }
  return picks;
}

function ensureDailyMissions(){
  const tk = todayKey();
  if(missionsState.dateKey !== tk){
    // reset day
    missionsState.dateKey = tk;
    missionsState.picks = pickDailyMissions();
    missionsState.claimed = {};
    missionsState.selectedId = missionsState.picks[0] || null;

    dailyKey = tk;
    dailyRolls = 0;
    dailyCometRolls = 0;
    dailyLuckyUsed = 0;
    dailyPlayMs = 0;
    dailyExplored = { Desert:false, Zero:false, Windstorm:false, Chrono:false };

    saveGame();
  }

  if(!missionsState.picks || missionsState.picks.length !== 3){
    missionsState.picks = pickDailyMissions();
    missionsState.selectedId = missionsState.picks[0] || null;
  }
  if(!missionsState.selectedId) missionsState.selectedId = missionsState.picks[0] || null;
}

function applyMissionReward(rew){
  if(rew.coins){
    coins += rew.coins;
    updateCoinsUI();
    sfx("coin");
    pulseUI(document.getElementById('coinsWrap'));
    floatCoins(+rew.coins);
  }
  if(rew.potions){
    for(const k of Object.keys(rew.potions)){
      potionInventory[k] = (potionInventory[k]||0) + rew.potions[k];
    }
    renderPotions();
    renderActivePotions();
  }
}

function renderMissions(){
  ensureDailyMissions();

  const dateLine = document.getElementById("missionsDateLine");
  const refreshLine = document.getElementById("missionsRefreshLine");
  if(dateLine) dateLine.textContent = formatTodayLine();
  if(refreshLine) refreshLine.textContent = `Refresh in ${formatHMS(msToMidnight())}`;

  const list = document.getElementById("missionsList");
  if(!list) return;
  list.innerHTML = "";

  missionsState.picks.forEach((id)=>{
    const def = getMissionDef(id);
    const prog = missionProgress(def);
    const claimed = !!missionsState.claimed[id];

    const row = document.createElement("div");
    row.className = "missionRow";
    row.onclick = ()=>{ missionsState.selectedId = id; renderMissionDetail(); saveGame(); };

    const left = document.createElement("div");
    left.className = "missionLeft";

    const t = document.createElement("div");
    t.className = "missionTitle";
    t.textContent = def ? def.title : id;

    const p = document.createElement("div");
    p.className = "missionProg";
    if(prog.isTime){
      p.textContent = `${formatHMS(prog.cur)} / ${formatHMS(prog.max)}`;
    }else{
      p.textContent = `${Math.min(prog.cur, prog.max)} / ${prog.max}`;
    }

    left.appendChild(t);
    left.appendChild(p);

    const right = document.createElement("div");
    right.className = "missionRight";

    const check = document.createElement("div");
    check.className = "missionCheck";
    if(claimed) check.classList.add("claimed");
    if(prog.done) check.classList.add("done");
    check.textContent = claimed ? "✓" : (prog.done ? "✓" : "");

    right.appendChild(check);

    row.appendChild(left);
    row.appendChild(right);
    list.appendChild(row);
  });

  renderMissionDetail();
}

function renderMissionDetail(){
  const panel = document.getElementById("missionDetail");
  if(!panel) return;

  const id = missionsState.selectedId;
  const def = getMissionDef(id);

  if(!def){
    panel.innerHTML = `
      <h3>Select a mission</h3>
      <div class="desc">Click a mission on the left to see details and claim the reward.</div>
      <div class="reward"><b>Reward:</b> —</div>
      <div class="actions">
        <button disabled>Claim</button>
        <button onclick="closeMissions()">Close</button>
      </div>
    `;
    return;
  }

  const prog = missionProgress(def);
  const claimed = !!missionsState.claimed[id];
  const canClaim = prog.done && !claimed;

  panel.innerHTML = `
    <h3>${def.title}</h3>
    <div class="desc">${def.desc}</div>
    <div class="reward">
      <b>Reward:</b> ${rewardText(def.reward)}<br>
      <span style="color:#cfcfcf;">
        Progress: ${prog.isTime ? `${formatHMS(prog.cur)} / ${formatHMS(prog.max)}` : `${Math.min(prog.cur, prog.max)} / ${prog.max}`}
      </span>
    </div>
    <div class="actions">
      <button id="missionClaimBtn" ${canClaim ? "" : "disabled"}>${claimed ? "Claimed" : "Claim"}</button>
      <button onclick="closeMissions()">Close</button>
    </div>
  `;

  const claimBtn = document.getElementById("missionClaimBtn");
  if(claimBtn){
    claimBtn.onclick = ()=>{
      if(!canClaim) return;
      missionsState.claimed[id] = true;
      applyMissionReward(def.reward);
      sfx("rare");
      renderMissions();
      saveGame();
    };
  }
}

/* overlay open/close */
function openMissions(){
  playPanelAnimOpen();
  setTimeout(()=>{
    const overlay=document.getElementById('missionsOverlay');
    overlay.classList.add('show');
    overlay.setAttribute('aria-hidden','false');
    renderMissions();
  }, 260);
}
function closeMissions(){
  const overlay=document.getElementById('missionsOverlay');
  overlay.classList.remove('show');
  overlay.setAttribute('aria-hidden','true');
  playPanelAnimClose();
}

document.getElementById('missionsClose').onclick = closeMissions;
document.getElementById('missionsOverlay').addEventListener('click',(e)=>{
  if(e.target.id==='missionsOverlay') closeMissions();
});

/* refresh timer line */
setInterval(()=>{
  ensureDailyMissions();
  const refreshLine = document.getElementById("missionsRefreshLine");
  if(refreshLine) refreshLine.textContent = `Refresh in ${formatHMS(msToMidnight())}`;
}, 1000);

/* playtime tracker (daily) */
let lastPlayTick = Date.now();
setInterval(()=>{
  ensureDailyMissions();
  if(document.visibilityState !== "visible") return;
  const now = Date.now();
  const dt = Math.min(2000, Math.max(0, now - lastPlayTick));
  lastPlayTick = now;
  dailyPlayMs += dt;
  // se overlay aberto, atualiza progresso
  const overlay = document.getElementById("missionsOverlay");
  if(overlay && overlay.classList.contains("show")) renderMissions();
}, 1000);

/* expose */
window.openMissions = openMissions;
window.closeMissions = closeMissions;

/* =========================
   INIT
========================= */
function runIntro(){
  const overlay = document.getElementById('introOverlay');

  overlay.classList.add('show');

  setTimeout(()=>{
    overlay.classList.remove('show');
    overlay.classList.add('fadeout');
  }, 2500);

  setTimeout(()=>{
    overlay.remove();
    const app = document.getElementById('app');
    app.classList.add('ready');
  }, 2500 + 900 + 500);
}

loadGame();

ensureDailyMissions();
refreshRolling();
refreshStorage();
renderEffects();
updateEquipped();
updateBiomeLabel();
applyBiomeFXClass();
renderPotions();
renderActivePotions();
updateCoinsUI();
document.getElementById('rollsLabel').innerText=`Rolls: ${rollCount}`;

updateBonusLabel();
updateCurrentLuckUI(bonusArmed ? 1.5 : 1);

startBiomeSchedulers();
setInterval(saveGame, 8000);


// =========================
// PLAYER NAME
// =========================
let playerName = localStorage.getItem("an_rng_player_name") || "";

function askPlayerName(){
  if(!playerName){
    document.getElementById("nameOverlay").style.display = "flex";
  }
}

function confirmPlayerName(){
  const v = document.getElementById("playerNameInput").value.trim();
  if(!v) return;
  playerName = v;
  localStorage.setItem("an_rng_player_name", playerName);
  document.getElementById("nameOverlay").style.display = "none";
}

/* start intro last */
runIntro();
/* =========================
   SAVE ao sair/fechar + background
========================= */
function safeSaveNow(){
  try { saveGame(); } catch(e) {}
}

// 1) quando o usuário fecha a aba / recarrega / sai
window.addEventListener("beforeunload", () => {
  safeSaveNow();
});

// 2) quando a aba perde foco (minimiza, troca de aba, celular bloqueia, etc)
document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "hidden") {
    safeSaveNow();
  }
});

// 3) quando o navegador “congela” a página (mobile / economia de energia)
window.addEventListener("pagehide", () => {
  safeSaveNow();
});
</script>
</body>
</html>
